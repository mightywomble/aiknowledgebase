<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f8fafc; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .prose-styles { color: #334155; }
        .prose-styles h3 { color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25em; margin-top: 1em; margin-bottom: 0.5em;}
        .prose-styles a { color: #4f46e5; }
        .prose-styles a:hover { text-decoration: underline; }
        .prose-styles code { background-color: #e2e8f0; padding: 0.2em 0.4em; border-radius: 3px; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 200ms; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 200ms; }
        .glass-pane {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="flex h-screen bg-white">
        <!-- Sidebar -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shrink-0">
            <div class="h-16 flex items-center px-6 border-b border-gray-200">
                <a href="{{ url_for('index') }}" class="flex items-center">
                    <svg class="h-8 w-8 text-indigo-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="ml-3 text-lg font-semibold text-gray-800">KB Project</span>
                </a>
            </div>
            
            <div class="px-4 py-4 border-b border-gray-200">
                <form id="filter-form" method="GET" action="{{ url_for('index') }}" class="space-y-3">
                    <input type="text" name="search" placeholder="Search articles..." value="{{ search_term or '' }}" class="w-full px-3 py-2 text-sm bg-gray-100 border-transparent rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <select name="sort" onchange="this.form.submit()" class="w-full px-3 py-2 text-sm bg-gray-100 border-transparent rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="category" {% if sort_by == 'category' %}selected{% endif %}>Sort by Category</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Sort by Newest</option>
                        <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>Sort by Title (A-Z)</option>
                        <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>Sort by Title (Z-A)</option>
                    </select>
                </form>
            </div>

            <nav id="kb-nav" class="flex-1 px-4 py-2 overflow-y-auto">
                <div id="bulk-actions-bar" class="hidden sticky top-0 bg-white/80 backdrop-blur-sm z-10 p-2 border-b mb-2 rounded-md">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-semibold"><span id="selection-count">0</span> selected</p>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-600">Select All</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <button id="bulk-update-btn" class="flex-1 text-xs bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Update</button>
                        <button id="bulk-delete-btn" class="flex-1 text-xs bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600">Delete</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                {% set current_category = '' %}
                {% for article in articles %}
                    {% if sort_by == 'category' and article.category.name != current_category %}
                        {% set current_category = article.category.name %}
                        <h3 class="text-md font-bold text-gray-600 px-2 pt-4 col-span-1">{{ current_category }}</h3>
                    {% endif %}
                    <div class="p-3 rounded-lg shadow-sm relative group" style="background-color: {{ article.category.color }};">
                        <div class="absolute top-2 right-2 flex items-center">
                             <button class="edit-article-btn p-1 text-gray-500 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity" data-id="{{ article.id }}">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" /></svg>
                            </button>
                            <input type="checkbox" class="h-4 w-4 rounded border-gray-400 text-indigo-600 focus:ring-indigo-500 article-checkbox ml-1" data-id="{{ article.id }}">
                        </div>
                        <a href="#" class="block font-semibold text-gray-800 hover:text-black article-link" data-id="{{ article.id }}">{{ article.title }}</a>
                    </div>
                {% else %}
                    <p class="px-4 text-sm text-gray-500">No articles found.</p>
                {% endfor %}
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-50">
            <header class="h-16 flex items-center justify-between px-8 border-b border-gray-200 bg-white z-10">
                <div class="flex-1"></div> <!-- Left Spacer -->
                <form id="ask-form" class="w-full max-w-2xl">
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                        <input type="text" id="question-input" class="w-full pl-10 pr-4 py-2 bg-gray-100 border-transparent rounded-lg focus:bg-white focus:border-indigo-300" placeholder="Ask a question to get started...">
                    </div>
                </form>
                <div class="flex-1 flex justify-end">
                    <a href="{{ url_for('settings_page') }}" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition-colors">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226a2.25 2.25 0 012.58 1.226l.114.683c.137.82.715 1.51 1.505 1.87l.79.395c.837.418 1.258 1.487 1.018 2.45l-.523 1.942a2.25 2.25 0 01-1.342 1.616.25.25 0 00-.056.09l-.443.886c-.42.84-.172 1.86.52 2.445l.698.582c.85.71 1.998.63 2.807-.184l.158-.158a2.25 2.25 0 013.182 0l.53.53a2.25 2.25 0 010 3.182l-.158.158c-.81.81-1.956.89-2.807.184l-.698-.582c-.692-.585-1.626-.755-2.445-.52l-.886.443a.25.25 0 00-.09.056 2.25 2.25 0 01-1.616 1.342l-1.942.523c-.962.24-1.998-.18-2.45-1.018l-.395-.79a2.25 2.25 0 00-1.87-1.505l-.683-.114a2.25 2.25 0 01-1.226-2.58l.114-.683c.26-1.543-.826-3.023-2.38-3.32l-.79-.158a2.25 2.25 0 01-1.98-2.288v-.04c0-1.26.95-2.322 2.18-2.496l.79-.158c1.554-.3 2.64-1.777 2.38-3.32l-.114-.683z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </a>
                </div>
            </header>
            <div id="results-area" class="flex-1 flex flex-col gap-6 p-6 overflow-y-auto">
                <div class="text-center text-gray-500 p-8 glass-pane rounded-xl flex-1 flex flex-col justify-center">
                    <h2 class="text-2xl font-bold text-gray-700">Welcome to your Knowledge Base</h2>
                    <p class="mt-2">Ask a question, or select an article from the left.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden z-40"></div>
    
    <div id="article-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <h2 id="modal-title" class="p-4 border-b text-2xl font-bold text-gray-900"></h2>
            <div id="modal-content" class="p-6 overflow-y-auto prose-styles"></div>
            <div class="p-4 bg-gray-50 border-t text-right rounded-b-xl">
                 <button onclick="closeModal('article-modal')" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Close</button>
            </div>
        </div>
    </div>

    <div id="synthesis-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="p-6 border-b text-xl font-medium text-gray-900">Create New KB Article</h3>
            <div id="synthesis-modal-content" class="p-6 space-y-4 overflow-y-auto"></div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-xl border-t">
                <button onclick="closeModal('synthesis-modal')" class="rounded-md bg-white px-3 py-2 text-sm font-semibold">Cancel</button>
                <button id="confirm-synthesis-btn" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white">Create Article</button>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="p-6 border-b text-xl font-medium text-gray-900">Edit Article</h3>
            <div id="edit-modal-content" class="p-6 space-y-4 overflow-y-auto"></div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-xl border-t">
                <button onclick="closeModal('edit-modal')" class="rounded-md bg-white px-3 py-2 text-sm font-semibold">Cancel</button>
                <button id="confirm-edit-btn" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div id="bulk-update-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 class="p-6 border-b text-xl font-medium text-gray-900">Bulk Update Articles</h3>
            <div class="p-6 space-y-4 overflow-y-auto">
                <p class="text-sm text-gray-600">Add information to all selected articles. Existing content will be kept.</p>
                <div>
                    <label for="bulk-notes" class="block text-sm font-medium text-gray-700">Notes to Add</label>
                    <textarea id="bulk-notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300"></textarea>
                </div>
                <div>
                    <label for="bulk-references" class="block text-sm font-medium text-gray-700">References to Add</label>
                    <textarea id="bulk-references" rows="2" class="mt-1 block w-full rounded-md border-gray-300"></textarea>
                </div>
                <div>
                    <label for="bulk-tags" class="block text-sm font-medium text-gray-700">Tags to Add</label>
                    <input type="text" id="bulk-tags" class="mt-1 block w-full rounded-md border-gray-300">
                    <div id="bulk-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-xl border-t">
                <button onclick="closeModal('bulk-update-modal')" class="rounded-md bg-white px-3 py-2 text-sm font-semibold">Cancel</button>
                <button id="confirm-bulk-update-btn" class="rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white">Update Articles</button>
            </div>
        </div>
    </div>

    <script>
        const allTags = {{ all_tags|tojson }};
        const allCategories = {{ categories|tojson|safe }};
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- Event Listeners ---
        $('#ask-form').addEventListener('submit', handleAskSubmit);
        $('#kb-nav').addEventListener('click', handleSidebarClick);
        $('#select-all-checkbox').addEventListener('change', handleSelectAll);
        $('#bulk-delete-btn').addEventListener('click', () => handleBulkAction('delete'));
        $('#bulk-update-btn').addEventListener('click', () => {
            renderTagButtons('bulk-tags-container', 'bulk-tags');
            openModal('bulk-update-modal');
        });
        $('#confirm-bulk-update-btn').addEventListener('click', () => handleBulkAction('update'));

        // --- Main Functions ---
        async function handleAskSubmit(e) {
            e.preventDefault();
            if (!$('#question-input').value.trim()) return;

            $('#results-area').innerHTML = `
                <div class="text-center p-8 glass-pane rounded-xl flex-1 flex flex-col justify-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Fetching Knowledge...</h3>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 10%"></div>
                    </div>
                    <p id="progress-status" class="text-sm text-gray-600">Initializing...</p>
                </div>`;
            
            const progressBar = $('#progress-bar');
            const progressStatus = $('#progress-status');

            try {
                progressStatus.textContent = 'Querying AI services...';
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: $('#question-input').value }),
                });
                
                progressBar.style.width = '75%';
                progressStatus.textContent = 'Processing results...';

                if (!response.ok) throw new Error('Network response was not ok');
                
                const results = await response.json();
                
                progressBar.style.width = '100%';
                progressStatus.textContent = 'Done!';

                setTimeout(() => displayResults(results), 500);

            } catch (error) {
                $('#results-area').innerHTML = `<div class="bg-red-100 p-4 rounded-lg">Error fetching answers.</div>`;
            }
        }

        function displayResults(results) {
            let topContent = '';
            if (results.gemini && results.gemini.toLowerCase().includes("quota")) {
                topContent += `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert"><p class="font-bold">Gemini API Quota Exceeded</p><p>You have reached your daily limit for the Gemini API. Results from other services are shown below.</p></div>`;
            }

            let mainContent = '<div class="space-y-6" id="synthesis-section">';
            let hasResults = false;

            if (results.gemini && !results.gemini.startsWith("Error:")) {
                mainContent += createResultCard('gemini', 'Google Gemini', results.gemini);
                hasResults = true;
            }
            if (results.chatgpt && !results.chatgpt.startsWith("Error:")) {
                mainContent += createResultCard('chatgpt', 'OpenAI ChatGPT', results.chatgpt);
                hasResults = true;
            }
            if (results.google && results.google.length > 0 && !results.google[0].title.startsWith("Error")) {
                 mainContent += createGoogleResultsCard(results.google);
                 hasResults = true;
            }
            mainContent += '</div>';
            
            if(hasResults) {
                mainContent += `<div class="mt-auto pt-4 text-center"><button id="start-synthesis-btn" class="rounded-md bg-green-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-green-500">Create Article from Selected</button></div>`;
            } else if (!topContent) { // Only show "No results" if there isn't already a quota message
                mainContent = `<div class="bg-yellow-100 p-4 rounded-lg">No results found. Check API keys in Settings.</div>`;
            }

            $('#results-area').innerHTML = topContent + mainContent;
            if(hasResults) $('#start-synthesis-btn').addEventListener('click', openSynthesisModal);
        }

        function handleSidebarClick(e) {
            const articleLink = e.target.closest('.article-link');
            const editBtn = e.target.closest('.edit-article-btn');
            const checkbox = e.target.closest('.article-checkbox');

            if (articleLink) {
                e.preventDefault();
                handleArticleClick(articleLink.dataset.id);
            }
            if (editBtn) {
                e.preventDefault();
                openEditModal(editBtn.dataset.id);
            }
            if (checkbox) {
                updateBulkActionBar();
            }
        }

        async function handleArticleClick(id) {
            const response = await fetch(`/get/article/${id}`);
            const article = await response.json();
            $('#modal-title').textContent = article.title;
            let contentHtml = `<h3>Synthesized Content</h3>${renderMarkdown(article.content)}`;
            if (article.notes) contentHtml += `<h3 class="mt-6">Notes</h3>${renderMarkdown(article.notes)}`;
            if (article.references) contentHtml += `<h3 class="mt-6">References</h3><ul>${article.references.split('\n').filter(Boolean).map(l => `<li><a href="${l}" target="_blank">${l}</a></li>`).join('')}</ul>`;
            if (article.tags) contentHtml += `<div class="mt-6"><h3>Tags</h3>${article.tags.split(',').map(t => `<span class="bg-indigo-100 text-xs mr-2 px-2.5 py-0.5 rounded-full">${t.trim()}</span>`).join('')}</div>`;
            $('#modal-content').innerHTML = contentHtml;
            openModal('article-modal');
        }
        
        function buildCategoryOptions(selectedId) {
            let html = '';
            const topLevel = allCategories.filter(c => c.parent_id === null);
            
            function renderOptions(categories, depth = 0) {
                for (const category of categories) {
                    const isSelected = category.id === selectedId ? 'selected' : '';
                    const prefix = '&nbsp;&nbsp;'.repeat(depth);
                    html += `<option value="${category.id}" ${isSelected}>${prefix}${category.name}</option>`;
                    const children = allCategories.filter(c => c.parent_id === category.id);
                    if (children.length > 0) {
                        renderOptions(children, depth + 1);
                    }
                }
            }
            renderOptions(topLevel);
            return html;
        }

        async function openEditModal(id) {
            const res = await fetch(`/get/article/${id}`);
            const article = await res.json();
            const content = `
                <input type="hidden" id="edit-id" value="${article.id}">
                <div><label class="block text-sm font-medium">Title</label><input type="text" id="edit-title" value="${escapeHTML(article.title)}" class="mt-1 w-full rounded-md border-gray-300"></div>
                <div><label class="block text-sm font-medium">Category</label><select id="edit-category-id" class="mt-1 w-full rounded-md border-gray-300">${buildCategoryOptions(article.category_id)}</select></div>
                <div><label class="block text-sm font-medium">Notes</label><textarea id="edit-notes" rows="4" class="mt-1 w-full rounded-md border-gray-300">${escapeHTML(article.notes)}</textarea></div>
                <div><label class="block text-sm font-medium">References</label><textarea id="edit-references" rows="2" class="mt-1 w-full rounded-md border-gray-300">${escapeHTML(article.references)}</textarea></div>
                <div>
                    <label class="block text-sm font-medium">Tags</label>
                    <input type="text" id="edit-tags" value="${escapeHTML(article.tags)}" class="mt-1 w-full rounded-md border-gray-300">
                    <div id="edit-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            `;
            $('#edit-modal-content').innerHTML = content;
            renderTagButtons('edit-tags-container', 'edit-tags');
            $('#confirm-edit-btn').onclick = handleConfirmEdit;
            openModal('edit-modal');
        }

        async function handleConfirmEdit() {
            const id = $('#edit-id').value;
            const payload = {
                title: $('#edit-title').value, category_id: $('#edit-category-id').value,
                notes: $('#edit-notes').value, references: $('#edit-references').value, tags: $('#edit-tags').value
            };
            await fetch(`/edit/article/${id}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            location.reload();
        }

        function openSynthesisModal() {
            const selectedCheckboxes = $$('#synthesis-section input:checked');
            if (selectedCheckboxes.length === 0) return alert('Please select results to create an article.');
            const content = `
                <div><label class="block text-sm font-medium">Title</label><input type="text" id="new-title" class="mt-1 w-full rounded-md border-gray-300"></div>
                <div><label class="block text-sm font-medium">Category</label><select id="new-category-id" class="mt-1 w-full rounded-md border-gray-300">${buildCategoryOptions()}</select></div>
                <div><label class="block text-sm font-medium">Notes</label><textarea id="new-notes" rows="4" class="mt-1 w-full rounded-md border-gray-300"></textarea></div>
                <div><label class="block text-sm font-medium">References</label><textarea id="new-references" rows="2" class="mt-1 w-full rounded-md border-gray-300"></textarea></div>
                <div>
                    <label class="block text-sm font-medium">Tags</label>
                    <input type="text" id="new-tags" class="mt-1 w-full rounded-md border-gray-300">
                    <div id="new-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            `;
            $('#synthesis-modal-content').innerHTML = content;

            const references = Array.from(selectedCheckboxes)
                .map(cb => cb.dataset.link)
                .filter(Boolean);
            if (references.length > 0) {
                $('#new-references').value = references.join('\n');
            }

            renderTagButtons('new-tags-container', 'new-tags');
            $('#confirm-synthesis-btn').onclick = handleConfirmSynthesis;
            openModal('synthesis-modal');
        }

        async function handleConfirmSynthesis() {
            const textsToSynthesize = Array.from($$('#synthesis-section input:checked')).map(checkbox => {
                return checkbox.dataset.content;
            });

            const payload = {
                title: $('#new-title').value, category_id: $('#new-category-id').value,
                notes: $('#new-notes').value, references: $('#new-references').value, tags: $('#new-tags').value,
                texts: textsToSynthesize
            };
            if (!payload.title || !payload.category_id) return alert('Title and Category are required.');
            
            const btn = $('#confirm-synthesis-btn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            await fetch('/synthesize', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            location.reload();
        }
        
        async function handleBulkAction(action) {
            const ids = Array.from($$('.article-checkbox:checked')).map(cb => cb.dataset.id);
            if (ids.length === 0) return;
            
            let payload = { action, ids };
            if (action === 'update') {
                payload.data = {
                    notes: $('#bulk-notes').value,
                    references: $('#bulk-references').value,
                    tags: $('#bulk-tags').value
                };
                closeModal('bulk-update-modal');
            } else if (action === 'delete') {
                if (!confirm(`Are you sure you want to delete ${ids.length} articles?`)) return;
            }

            await fetch('/bulk_action', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            location.reload();
        }
        
        function handleSelectAll(e) {
            $$('.article-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
            updateBulkActionBar();
        }

        function updateBulkActionBar() {
            const count = $$('.article-checkbox:checked').length;
            $('#selection-count').textContent = count;
            $('#bulk-actions-bar').classList.toggle('hidden', count === 0);
        }

        // --- UI & Modal ---
        function openModal(id) {
            const modal = $(`#${id}`);
            if (!modal) return;
            
            $('#modal-backdrop').classList.remove('hidden');
            modal.classList.remove('hidden');
            
            void modal.offsetWidth; 

            modal.classList.add('modal-enter-active');
            modal.classList.remove('modal-enter');
        }

        function closeModal(id) {
            const modal = $(`#${id}`);
            if (!modal) return;

            modal.classList.add('modal-leave-active');
            modal.classList.remove('modal-enter-active');

            setTimeout(() => {
                // Clear inputs only on synthesis modal close
                if (id === 'synthesis-modal') {
                    ['new-title', 'new-category-id', 'new-notes', 'new-references', 'new-tags'].forEach(inputId => {
                        const el = $(`#${inputId}`);
                        if (el) el.value = '';
                    });
                    const btn = $('#confirm-synthesis-btn');
                    btn.disabled = false;
                    btn.textContent = 'Create Article';
                }

                $('#modal-backdrop').classList.add('hidden');
                modal.classList.add('hidden');
                modal.classList.remove('modal-leave-active');
                modal.classList.add('modal-enter');
            }, 200);
        }
        
        function renderTagButtons(containerId, inputId) {
            const container = $(`#${containerId}`);
            container.innerHTML = allTags.map(tag => `<button class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-full" data-tag="${escapeHTML(tag)}">${escapeHTML(tag)}</button>`).join('');
            container.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    const tag = e.target.dataset.tag;
                    const input = $(`#${inputId}`);
                    const currentTags = new Set(input.value.split(',').map(t => t.trim()).filter(Boolean));
                    currentTags.add(tag);
                    input.value = Array.from(currentTags).join(', ');
                }
            });
        }
        
        function createResultCard(id, title, content) {
            return `<div class="bg-white/80 p-5 rounded-lg border"><label for="check-${id}" class="flex items-start cursor-pointer"><input type="checkbox" id="check-${id}" class="mt-1 h-5 w-5" data-content="${escapeHTML(content)}"><div class="ml-4"><h4 class="font-bold text-lg text-indigo-700">${title}</h4><div class="mt-2 text-gray-600 prose-styles">${renderMarkdown(content)}</div></div></label></div>`;
        }
        function createGoogleResultsCard(items) {
            const googleItems = items.map((item, i) => {
                const content = `Title: ${item.title}\nSnippet: ${item.snippet}\nLink: ${item.link}`;
                return `<div class="border-t pt-3 mt-3 first:mt-0 first:border-t-0"><label for="check-google-${i}" class="flex items-start cursor-pointer"><input type="checkbox" id="check-google-${i}" class="mt-1 h-5 w-5" data-content="${escapeHTML(content)}" data-link="${escapeHTML(item.link)}"><div class="ml-4"><a href="${item.link}" target="_blank" class="hover:underline font-semibold">${item.title}</a><p class="text-sm mt-1">${item.snippet}</p></div></label></div>`
            }).join('');
            return `<div class="bg-white/80 p-5 rounded-lg border"><h4 class="font-bold text-lg text-blue-700">Google Search</h4><div class="mt-2">${googleItems}</div></div>`;
        }
        function escapeHTML(str) { 
            return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        function renderMarkdown(text) {
            let html = escapeHTML(text || '');
            return html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }
    </script>
</body>
</html>
