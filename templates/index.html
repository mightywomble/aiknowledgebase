<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .prose-styles { color: #334155; }
        .prose-styles h1, .prose-styles h2, .prose-styles h3 { color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25em; margin-top: 1em; margin-bottom: 0.5em;}
        .prose-styles p { margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.6; }
        .prose-styles ul { list-style-type: disc; margin-left: 1.5em; }
        .prose-styles ol { list-style-type: decimal; margin-left: 1.5em; }
        .prose-styles a { color: #4f46e5; text-decoration: none; }
        .prose-styles a:hover { text-decoration: underline; }
        .prose-styles strong { color: #1e293b; }
        .prose-styles code { background-color: #e2e8f0; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; font-family: monospace; }
        .prose-styles pre { background-color: #f1f5f9; padding: 1em; border-radius: 0.5rem; overflow-x: auto; }
        .prose-styles pre code { background-color: transparent; padding: 0; }
        .prose-styles blockquote { border-left: 4px solid #cbd5e1; padding-left: 1em; color: #64748b; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 300ms; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 300ms; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="flex h-screen bg-white">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col shrink-0">
            <div class="h-16 flex items-center px-6 border-b border-gray-200">
                <svg class="h-8 w-8 text-indigo-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="ml-3 text-lg font-semibold text-gray-800">KB Project</span>
            </div>
            <nav id="kb-nav" class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                <a href="{{ url_for('index') }}" class="flex items-center px-4 py-2 text-gray-900 bg-gray-200 rounded-lg">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.5 1.5 0 012.122 0l8.954 8.955M21 12v9a2 2 0 01-2 2H5a2 2 0 01-2-2v-9M15 21v-4.5A2.5 2.5 0 0012.5 14h-1A2.5 2.5 0 009 16.5V21" /></svg>
                    <span class="ml-3">Home</span>
                </a>
                <a href="{{ url_for('settings_page') }}" class="flex items-center px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226a2.25 2.25 0 012.58 1.226l.114.683c.137.82.715 1.51 1.505 1.87l.79.395c.837.418 1.258 1.487 1.018 2.45l-.523 1.942a2.25 2.25 0 01-1.342 1.616.25.25 0 00-.056.09l-.443.886c-.42.84-.172 1.86.52 2.445l.698.582c.85.71 1.998.63 2.807-.184l.158-.158a2.25 2.25 0 013.182 0l.53.53a2.25 2.25 0 010 3.182l-.158.158c-.81.81-1.956.89-2.807.184l-.698-.582c-.692-.585-1.626-.755-2.445-.52l-.886.443a.25.25 0 00-.09.056 2.25 2.25 0 01-1.616 1.342l-1.942.523c-.962.24-1.998-.18-2.45-1.018l-.395-.79a2.25 2.25 0 00-1.87-1.505l-.683-.114a2.25 2.25 0 01-1.226-2.58l.114-.683c.26-1.543-.826-3.023-2.38-3.32l-.79-.158a2.25 2.25 0 01-1.98-2.288v-.04c0-1.26.95-2.322 2.18-2.496l.79-.158c1.554-.3 2.64-1.777 2.38-3.32l-.114-.683z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span class="ml-3">Settings</span>
                </a>
                <div class="px-4 pt-4 pb-2 text-xs font-semibold text-gray-500 uppercase">Knowledge Base</div>
                {% if categories %}
                    {% for category in categories %}
                        <div class="mb-4">
                            <h3 class="text-md font-bold text-indigo-600 px-4">{{ category.name }}</h3>
                            <ul class="mt-1 space-y-1">
                                {% for article in category.articles %}
                                    <li class="flex items-center justify-between text-sm text-gray-600 hover:bg-gray-100 rounded-lg group">
                                        <a href="#" class="flex-grow py-2 px-4 hover:text-gray-900 article-link" data-id="{{ article.id }}">
                                            - {{ article.title }}
                                        </a>
                                        <button class="delete-article-btn p-2 text-gray-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-id="{{ article.id }}">
                                            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                                        </button>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="px-4 text-sm text-gray-500">No articles yet.</p>
                {% endif %}
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 flex items-center justify-center px-8 border-b border-gray-200 bg-white">
                <form id="ask-form" class="w-full max-w-2xl">
                    <div class="relative">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                        <input type="text" id="question-input" class="w-full pl-10 pr-4 py-2 bg-gray-100 border border-transparent rounded-lg focus:bg-white focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition" placeholder="Ask a question to get started...">
                    </div>
                </form>
            </header>
            <div id="results-area" class="flex-1 overflow-y-auto p-8 bg-gray-50">
                <div class="text-center text-gray-500">
                    <h2 class="text-2xl font-bold">Welcome to your Knowledge Base</h2>
                    <p class="mt-2">Ask a question above to search Google, Gemini, and ChatGPT.</p>
                    <p>Then, select the results to create a new KB article.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden z-40"></div>
    
    <!-- Article Viewer Modal -->
    <div id="article-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-900"></h2>
                <button onclick="closeArticleModal()" class="text-gray-400 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto prose-styles"></div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 text-right rounded-b-xl">
                 <button onclick="closeArticleModal()" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Close</button>
            </div>
        </div>
    </div>

    <!-- Synthesis Input Modal -->
    <div id="synthesis-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Create New KB Article</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="new-title" class="block text-sm font-medium text-gray-700">Article Title</label>
                        <input type="text" id="new-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="new-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="new-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="e.g., Databases, Python">
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-xl">
                <button type="button" onclick="closeSynthesisModal()" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Cancel</button>
                <button type="button" id="confirm-synthesis-btn" class="inline-flex justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">Create Article</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden z-50 modal-enter">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6 text-center">
                <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <h3 class="mt-5 text-lg font-medium leading-6 text-gray-900">Delete Article</h3>
                <div class="mt-2">
                    <p class="text-sm text-gray-500">Are you sure? This action cannot be undone.</p>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-xl">
                <button type="button" id="confirm-cancel-btn" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Cancel</button>
                <button type="button" id="confirm-ok-btn" class="inline-flex justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Delete</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const askForm = document.getElementById('ask-form');
        const questionInput = document.getElementById('question-input');
        const resultsArea = document.getElementById('results-area');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const kbNav = document.getElementById('kb-nav');

        // --- Event Listeners ---
        askForm.addEventListener('submit', handleAskSubmit);
        document.getElementById('confirm-synthesis-btn').addEventListener('click', handleSynthesis);
        
        // Use event delegation for article links and delete buttons
        kbNav.addEventListener('click', (e) => {
            const articleLink = e.target.closest('.article-link');
            const deleteBtn = e.target.closest('.delete-article-btn');

            if (articleLink) {
                e.preventDefault();
                const articleId = articleLink.dataset.id;
                handleArticleClick(articleId);
            }

            if (deleteBtn) {
                e.preventDefault();
                const articleId = deleteBtn.dataset.id;
                handleArticleDelete(articleId);
            }
        });


        // --- Main Functions ---
        async function handleAskSubmit(e) {
            e.preventDefault();
            const question = questionInput.value.trim();
            if (!question) return;

            resultsArea.innerHTML = `
                <div class="text-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
                    <p class="mt-4 text-gray-500">Searching for answers...</p>
                </div>`;
            
            try {
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const results = await response.json();
                displayResults(results);
            } catch (error) {
                console.error('Error fetching answers:', error);
                resultsArea.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 p-4 rounded-lg"><strong>Error:</strong> Could not fetch answers. Check server logs.</div>`;
            }
        }

        function displayResults(results) {
            resultsArea.innerHTML = `
                <div class="space-y-6" id="synthesis-section"></div>
                <div class="mt-8 text-center">
                    <button id="start-synthesis-btn" class="rounded-md bg-green-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                        Create KB Article from Selected
                    </button>
                </div>`;
            
            const synthesisSection = document.getElementById('synthesis-section');
            let hasResults = false;

            if (results.gemini && !results.gemini.startsWith("Error:")) {
                synthesisSection.innerHTML += createResultCard('gemini', 'Google Gemini', results.gemini);
                hasResults = true;
            }
            if (results.chatgpt && !results.chatgpt.startsWith("Error:")) {
                synthesisSection.innerHTML += createResultCard('chatgpt', 'OpenAI ChatGPT', results.chatgpt);
                hasResults = true;
            }
            if (results.google && results.google.length > 0 && !results.google[0].title.startsWith("Error")) {
                 synthesisSection.innerHTML += createGoogleResultsCard(results.google);
                 hasResults = true;
            }

            if (!hasResults) {
                resultsArea.innerHTML = `<div class="bg-yellow-100 border border-yellow-400 text-yellow-800 p-4 rounded-lg"><strong>Notice:</strong> No results were returned. Please check your API keys in the Settings page.</div>`;
                return;
            }
            
            document.getElementById('start-synthesis-btn').addEventListener('click', openSynthesisModal);
        }

        async function handleSynthesis() {
            const selectedCheckboxes = document.querySelectorAll('#synthesis-section input[type="checkbox"]:checked');
            const newTitle = document.getElementById('new-title').value.trim();
            const newCategory = document.getElementById('new-category').value.trim();

            if (!newTitle || !newCategory) {
                alert('Please provide both a title and a category.');
                return;
            }

            const textsToSynthesize = Array.from(selectedCheckboxes).map(cb => cb.dataset.content);
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Synthesizing...';

            try {
                const response = await fetch('/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle, category: newCategory, texts: textsToSynthesize })
                });
                const result = await response.json();
                if (!response.ok || result.error) throw new Error(result.error || 'Synthesis failed.');
                
                closeSynthesisModal();
                location.reload();
            } catch (error) {
                console.error('Synthesis error:', error);
                alert(`Error: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'Create Article';
            }
        }
        
        async function handleArticleClick(articleId) {
            try {
                const response = await fetch(`/get/article/${articleId}`);
                if (!response.ok) {
                    throw new Error('Article not found');
                }
                const article = await response.json();
                showArticleModal(article.title, article.content);
            } catch (error) {
                console.error('Error fetching article:', error);
                alert('Could not load the article.');
            }
        }

        function handleArticleDelete(articleId) {
            showConfirmModal(async (confirmed) => {
                if (!confirmed) return;
                
                try {
                    const response = await fetch(`/delete/article/${articleId}`, {
                        method: 'POST',
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.message || 'Failed to delete article.');
                    }
                    location.reload();
                } catch(error) {
                    console.error('Error deleting article:', error);
                    alert(`Could not delete article: ${error.message}`);
                }
            });
        }

        // --- UI Card Creators ---
        function createResultCard(id, title, content) {
            return `
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm">
                    <label for="check-${id}" class="flex items-start cursor-pointer">
                        <input type="checkbox" id="check-${id}" class="mt-1 h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-content="${escapeHTML(content)}">
                        <div class="ml-4">
                            <h4 class="font-bold text-lg text-indigo-700">${title}</h4>
                            <div class="mt-2 text-gray-600 prose-styles">${renderMarkdown(content)}</div>
                        </div>
                    </label>
                </div>`;
        }

        function createGoogleResultsCard(items) {
            const googleItems = items.map((item, index) => {
                const content = `Title: ${item.title}\nSnippet: ${item.snippet}\nLink: ${item.link}`;
                return `
                <div class="border-t border-gray-200 pt-3 mt-3 first:mt-0 first:border-t-0 first:pt-0">
                    <label for="check-google-${index}" class="flex items-start cursor-pointer">
                        <input type="checkbox" id="check-google-${index}" class="mt-1 h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-content="${escapeHTML(content)}">
                        <div class="ml-4">
                            <a href="${item.link}" target="_blank" class="text-indigo-600 hover:underline font-semibold">${item.title}</a>
                            <p class="text-gray-500 text-sm mt-1">${item.snippet}</p>
                        </div>
                    </label>
                </div>`;
            }).join('');

            return `
                <div class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-lg text-blue-700">Google Search Results</h4>
                    <div class="mt-2 space-y-1">${googleItems}</div>
                </div>`;
        }

        // --- Modal Control ---
        const articleModal = document.getElementById('article-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        
        function showArticleModal(title, content) {
            modalTitle.textContent = title;
            modalContent.innerHTML = renderMarkdown(content);
            modalBackdrop.classList.remove('hidden');
            articleModal.classList.remove('hidden');
            articleModal.classList.add('modal-enter-active');
            articleModal.classList.remove('modal-enter');
        }

        function closeArticleModal() {
            articleModal.classList.add('modal-leave-active');
            setTimeout(() => {
                modalBackdrop.classList.add('hidden');
                articleModal.classList.add('hidden');
                articleModal.classList.remove('modal-enter-active', 'modal-leave-active');
            }, 300);
        }

        const synthesisModal = document.getElementById('synthesis-modal');

        function openSynthesisModal() {
            const selectedCheckboxes = document.querySelectorAll('#synthesis-section input[type="checkbox"]:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select at least one result to create an article.');
                return;
            }
            modalBackdrop.classList.remove('hidden');
            synthesisModal.classList.remove('hidden');
            synthesisModal.classList.add('modal-enter-active');
            synthesisModal.classList.remove('modal-enter');
        }

        function closeSynthesisModal() {
            synthesisModal.classList.add('modal-leave-active');
            setTimeout(() => {
                modalBackdrop.classList.add('hidden');
                synthesisModal.classList.add('hidden');
                synthesisModal.classList.remove('modal-enter-active', 'modal-leave-active');
                document.getElementById('new-title').value = '';
                document.getElementById('new-category').value = '';
                document.getElementById('confirm-synthesis-btn').disabled = false;
                document.getElementById('confirm-synthesis-btn').textContent = 'Create Article';
            }, 300);
        }
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        function showConfirmModal(callback) {
            modalBackdrop.classList.remove('hidden');
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('modal-enter-active');
            confirmModal.classList.remove('modal-enter');

            const handleOk = () => {
                callback(true);
                closeConfirmModal();
                cleanup();
            };
            const handleCancel = () => {
                callback(false);
                closeConfirmModal();
                cleanup();
            };
            const cleanup = () => {
                confirmOkBtn.removeEventListener('click', handleOk);
                confirmCancelBtn.removeEventListener('click', handleCancel);
            };

            confirmOkBtn.addEventListener('click', handleOk);
            confirmCancelBtn.addEventListener('click', handleCancel);
        }

        function closeConfirmModal() {
            confirmModal.classList.add('modal-leave-active');
            setTimeout(() => {
                // Keep backdrop if another modal is open
                if (articleModal.classList.contains('hidden') && synthesisModal.classList.contains('hidden')) {
                    modalBackdrop.classList.add('hidden');
                }
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('modal-enter-active', 'modal-leave-active');
            }, 300);
        }


        // --- Utility Functions ---
        function escapeHTML(str) {
            const text = str || '';
            return text.replace(/&/g, '&amp;')
                       .replace(/</g, '&lt;')
                       .replace(/>/g, '&gt;')
                       .replace(/"/g, '&quot;')
                       .replace(/'/g, '&#039;');
        }

        function renderMarkdown(text) {
            if (!text) return '';
            let html = escapeHTML(text);
            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Blockquotes
            html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
            // Links
            html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
             // Lists
            html = html.replace(/^\s*[\-\*] (.*)/gm, '<ul><li>$1</li></ul>');
            html = html.replace(/<\/ul>\n<ul>/g, '');
            // Code blocks
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // Inline code
            html = html.replace(/`(.*?)`/g, '<code>$1</code>');
            // Newlines
            html = html.replace(/\n/g, '<br>').replace(/<br><(h[1-6]|ul|pre|blockquote)>/g, '<$1>').replace(/<\/(h[1-6]|ul|pre|blockquote)><br>/g, '</$1>');
            return html;
        }
    </script>
</body>
</html>
