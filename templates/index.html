<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added Marked.js for robust Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Added highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f8fafc; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .prose-styles { color: #334155; }
        .prose-styles h3 { color: #1e293b; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.25em; margin-top: 1em; margin-bottom: 0.5em;}
        .prose-styles a { color: #4f46e5; }
        .prose-styles a:hover { text-decoration: underline; }
        .prose-styles code:not(pre code) { background-color: #e2e8f0; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .prose-styles pre { background-color: #f1f5f9; padding: 1em; border-radius: 0.5rem; overflow-x: auto; }
        .prose-styles pre code { background-color: transparent; padding: 0; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 200ms; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 200ms; }
        .glass-pane {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="flex h-screen bg-white">
        <!-- Article List Sidebar -->
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shrink-0">
            <div class="h-16 flex items-center px-6 border-b border-gray-200">
                <a href="{{ url_for('index') }}" class="flex items-center">
                    <svg class="h-8 w-8 text-indigo-600" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20.5C12.5523 20.5 13 20.0523 13 19.5C13 18.9477 12.5523 18.5 12 18.5C11.4477 18.5 11 18.9477 11 19.5C11 20.0523 11.4477 20.5 12 20.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 18.5V16M12 8V4M12 4C9.23858 4 7 6.23858 7 9V11C7 13.7614 9.23858 16 12 16C14.7614 16 17 13.7614 17 11V9C17 6.23858 14.7614 4 12 4Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 9C6.44772 9 6 9.44772 6 10C6 10.5523 6.44772 11 7 11M17 9C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 12C6.44772 12 6 12.4477 6 13C6 13.5523 6.44772 14 7 14M17 12C17.5523 12 18 12.4477 18 13C18 13.5523 17.5523 14 17 14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 16C8.44772 16 8 16.4477 8 17C8 17.5523 8.44772 18 9 18M15 16C15.5523 16 16 16.4477 16 17C16 17.5523 15.5523 18 15 18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="ml-3 text-lg font-semibold text-gray-800">AI Knowledge System</span>
                </a>
            </div>
            
            <div class="px-4 py-4 border-b border-gray-200">
                <form id="filter-form" method="GET" action="{{ url_for('index') }}" class="space-y-3">
                    <input type="text" name="search" placeholder="Search articles..." value="{{ search_term or '' }}" class="w-full px-3 py-2 text-sm bg-gray-100 border-transparent rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <div class="grid grid-cols-2 gap-2">
                        <select name="group" onchange="this.form.submit()" class="w-full px-3 py-2 text-sm bg-gray-100 border-transparent rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Groups</option>
                            {% for group in all_groups %}
                            <option value="{{ group.id }}" {% if filter_group_id == group.id %}selected{% endif %}>{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <select name="tag" onchange="this.form.submit()" class="w-full px-3 py-2 text-sm bg-gray-100 border-transparent rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Tags</option>
                             {% for tag in all_tags %}
                            <option value="{{ tag }}" {% if filter_tag == tag %}selected{% endif %}>{{ tag }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <select name="sort" onchange="this.form.submit()" class="w-full px-3 py-2 text-sm bg-gray-100 border-transparent rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="group" {% if sort_by == 'group' %}selected{% endif %}>Sort by Group</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Sort by Newest</option>
                        <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>Sort by Title (A-Z)</option>
                        <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>Sort by Title (Z-A)</option>
                    </select>
                </form>
            </div>

            <nav id="kb-nav" class="flex-1 px-4 py-2 overflow-y-auto">
                <div id="bulk-actions-bar" class="hidden sticky top-0 bg-white/80 backdrop-blur-sm z-10 p-2 border-b mb-2 rounded-md">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-semibold"><span id="selection-count">0</span> selected</p>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-gray-600">Select All</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        {% if current_user.has_permission('can_edit_kb') %}
                        <button id="bulk-update-btn" class="flex-1 text-xs bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Update</button>
                        {% endif %}
                        {% if current_user.has_permission('can_delete_kb') %}
                        <button id="bulk-delete-btn" class="flex-1 text-xs bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600">Delete</button>
                        {% endif %}
                    </div>
                </div>
                
                <div>
                {% for group_name, items in articles|groupby('group.name') %}
                    <div>
                        <button class="w-full flex items-center justify-between text-left text-md font-bold text-gray-600 px-2 py-2 rounded-md hover:bg-gray-100 group-toggle" data-group-name="{{ group_name }}">
                            <span>{{ group_name }}</span>
                            <svg class="h-5 w-5 transform transition-transform chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div class="pl-2 pt-2 grid grid-cols-1 gap-3 article-list">
                        {% for article in items %}
                        <div class="p-3 rounded-lg shadow-sm relative group" style="background-color: {{ article.group.color }};">
                            <div class="absolute top-2 right-2 flex items-center">
                                 {% if current_user.has_permission('can_edit_kb') %}
                                 <button class="edit-article-btn p-1 text-gray-500 hover:text-blue-700 opacity-0 group-hover:opacity-100 transition-opacity" data-id="{{ article.id }}">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" /></svg>
                                </button>
                                {% endif %}
                                <input type="checkbox" class="h-4 w-4 rounded border-gray-400 text-indigo-600 focus:ring-indigo-500 article-checkbox ml-1" data-id="{{ article.id }}">
                            </div>
                            <a href="#" class="block font-semibold text-gray-800 hover:text-black article-link" data-id="{{ article.id }}">{{ article.title }}</a>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <p class="px-4 text-sm text-gray-500">No articles found.</p>
                {% endfor %}
                </div>
            </nav>
        </aside>

        <!-- Main Viewing Area -->
        <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
            <header class="h-16 flex items-center justify-between px-8 border-b border-gray-200 bg-white z-10">
                <div></div> <!-- Left Spacer -->
                 <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-600">Logged in as <strong>{{ current_user.name or current_user.username }}</strong></span>
                    {% if current_user.has_permission('is_admin') %}
                    <a href="{{ url_for('backup_restore_page') }}" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition-colors" title="Backup/Restore">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                    </a>
                    <a href="{{ url_for('user_management') }}" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition-colors" title="User Management">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.071M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M15 19.128L18 18.5" /></svg>
                    </a>
                    <a href="{{ url_for('settings_page', page='api') }}" class="p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-gray-100 transition-colors" title="Settings">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226a2.25 2.25 0 012.58 1.226l.114.683c.137.82.715 1.51 1.505 1.87l.79.395c.837.418 1.258 1.487 1.018 2.45l-.523 1.942a2.25 2.25 0 01-1.342 1.616.25.25 0 00-.056.09l-.443.886c-.42.84-.172 1.86.52 2.445l.698.582c.85.71 1.998.63 2.807-.184l.158-.158a2.25 2.25 0 013.182 0l.53.53a2.25 2.25 0 010 3.182l-.158.158c-.81.81-1.956.89-2.807-.184l-.698-.582c-.692-.585-1.626-.755-2.445-.52l-.886.443a.25.25 0 00-.09.056 2.25 2.25 0 01-1.616 1.342l-1.942.523c-.962.24-1.998-.18-2.45-1.018l-.395-.79a2.25 2.25 0 00-1.87-1.505l-.683-.114a2.25 2.25 0 01-1.226-2.58l.114-.683c.26-1.543-.826-3.023-2.38-3.32l-.79-.158a2.25 2.25 0 01-1.98-2.288v-.04c0-1.26.95-2.322 2.18-2.496l.79-.158c1.554-.3 2.64-1.777 2.38-3.32l-.114-.683z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="p-2 text-gray-500 hover:text-red-600 rounded-full hover:bg-gray-100 transition-colors" title="Logout">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                    </a>
                 </div>
            </header>
            <div id="results-area" class="flex-1 flex flex-col gap-6 p-6 overflow-y-auto pb-24">
                <div class="text-center text-gray-500 p-8 glass-pane rounded-xl flex-1 flex flex-col justify-center">
                    <h2 class="text-2xl font-bold text-gray-700">Welcome to your Knowledge Base</h2>
                    <p class="mt-2">Ask a question, or select an article from the left.</p>
                </div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-4 flex justify-center items-center gap-4">
                 <form id="ask-form" class="w-full max-w-2xl">
                    <div class="relative">
                        <input type="text" id="question-input" class="w-full pl-5 pr-12 py-3 bg-white border border-gray-300 rounded-full shadow-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Ask a question to get started...">
                        <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700">
                             <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.544l4.25-1.214a.75.75 0 01.642 1.285l-4.25 1.214a.75.75 0 00-.544.95l-1.414 4.949a.75.75 0 00.95.826L16.25 10l-13.145-7.711z" /></svg>
                        </button>
                    </div>
                </form>
                {% if current_user.has_permission('can_add_kb') %}
                <button id="start-synthesis-btn" class="hidden flex-shrink-0 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-5 rounded-full shadow-lg transition-transform transform hover:scale-105">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                {% endif %}
            </div>
        </main>
    </div>

    {% include '_modals.html' %}
    {% include '_scripts_index.html' %}
</body>
</html>
