<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Knowledge System</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <!-- ADDED: Tailwind CSS script to enable modal styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Modern CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/glassy-styles.css') }}">
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <!-- Animated background orbs -->
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <div class="flex h-screen">
        <!-- Article List Sidebar -->
        <aside class="sidebar-articles">
            <div class="sidebar-header">
                <a href="{{ url_for('index') }}" class="logo-link">
                    <svg class="logo-icon" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20.5C12.5523 20.5 13 20.0523 13 19.5C13 18.9477 12.5523 18.5 12 18.5C11.4477 18.5 11 18.9477 11 19.5C11 20.0523 11.4477 20.5 12 20.5Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 18.5V16M12 8V4M12 4C9.23858 4 7 6.23858 7 9V11C7 13.7614 9.23858 16 12 16C14.7614 16 17 13.7614 17 11V9C17 6.23858 14.7614 4 12 4Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 9C6.44772 9 6 9.44772 6 10C6 10.5523 6.44772 11 7 11M17 9C17.5523 9 18 9.44772 18 10C18 10.5523 17.5523 11 17 11" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M7 12C6.44772 12 6 12.4477 6 13C6 13.5523 6.44772 14 7 14M17 12C17.5523 12 18 12.4477 18 13C18 13.5523 17.5523 14 17 14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 16C8.44772 16 8 16.4477 8 17C8 17.5523 8.44772 18 9 18M15 16C15.5523 16 16 16.4477 16 17C16 17.5523 15.5523 18 15 18" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="logo-text">AI Knowledge System</span>
                </a>
            </div>
            
            <div class="filter-section">
                <form id="filter-form" method="GET" action="{{ url_for('index') }}" class="filter-form">
                    <input type="text" name="search" placeholder="Search articles..." value="{{ search_term or '' }}" class="search-filter">
                    <div class="filter-grid">
                        <select name="group" onchange="this.form.submit()" class="filter-select">
                            <option value="">All Groups</option>
                            {% set shown = [] %}
                            {% for group in all_groups if group.parent_id is none %}
                            <option value="{{ group.id }}" {% if filter_group_id == group.id %}selected{% endif %}>{{ group.name }}</option>
                            {% set shown = shown + [group.id] %}
                            {% for subgroup in all_groups if subgroup.parent_id == group.id %}
                            <option value="{{ subgroup.id }}" {% if filter_group_id == subgroup.id %}selected{% endif %}>&nbsp;&nbsp;&nbsp;&nbsp;{{ subgroup.name }}</option>
                            {% set shown = shown + [subgroup.id] %}
                            {% for subsubgroup in all_groups if subsubgroup.parent_id == subgroup.id %}
                            <option value="{{ subsubgroup.id }}" {% if filter_group_id == subsubgroup.id %}selected{% endif %}>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ subsubgroup.name }}</option>
                            {% endfor %}
                            {% endfor %}
                            {% endfor %}
                        </select>
                        <select name="tag" onchange="this.form.submit()" class="filter-select">
                            <option value="">All Tags</option>
                            {% for tag in all_tags %}
                            <option value="{{ tag }}" {% if filter_tag == tag %}selected{% endif %}>{{ tag }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="filter-grid">
                        <select name="sort" onchange="this.form.submit()" class="filter-select">
                            <option value="group" {% if sort_by == 'group' %}selected{% endif %}>Sort by Group</option>
                            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Sort by Newest</option>
                            <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>Sort by Title (A-Z)</option>
                            <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>Sort by Title (Z-A)</option>
                        </select>
                        <select name="visibility" onchange="this.form.submit()" class="filter-select">
                            <option value="all" {% if filter_visibility == 'all' %}selected{% endif %}>All Articles</option>
                            <option value="local" {% if filter_visibility == 'local' %}selected{% endif %}>My Local</option>
                            <option value="shared" {% if filter_visibility == 'shared' %}selected{% endif %}>Shared</option>
                        </select>
                    </div>
                </form>
            </div>

            <nav id="kb-nav" class="articles-nav">
                <div id="bulk-actions-bar" class="bulk-actions hidden">
                    <div class="bulk-header">
                        <p class="bulk-count"><span id="selection-count">0</span> selected</p>
                        <label class="select-all-label">
                            <input type="checkbox" id="select-all-checkbox" class="select-checkbox">
                            <span>Select All</span>
                        </label>
                    </div>
                    <div class="bulk-buttons">
                        {% if current_user.has_permission('can_edit_kb') %}
                        <button id="bulk-update-btn" class="bulk-btn bulk-update">Update</button>
                        {% endif %}
                        {% if current_user.has_permission('can_delete_kb') %}
                        <button id="bulk-delete-btn" class="bulk-btn bulk-delete">Delete</button>
                        {% endif %}
                    </div>
                </div>
                
                <div class="articles-list">
                {% for group_name, items in articles|groupby('group.name') %}
                    <div class="group-section">
                        <button class="group-toggle" data-group-name="{{ group_name }}">
                            <span>{{ group_name }}</span>
                            <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div class="article-list">
                        {% for article in items %}
                        <div class="article-item" style="background: linear-gradient(135deg, {{ article.group.color }}22, {{ article.group.color }}11);">
                            <div class="article-checkbox-wrapper">
                                <input type="checkbox" class="article-checkbox" data-id="{{ article.id }}">
                            </div>
                            {% if current_user.id == article.user_id or current_user.has_permission('is_admin') %}
                            <div class="article-edit-wrapper">
                                <button class="edit-article-btn" data-id="{{ article.id }}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" />
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                            <div class="article-content">
                                {% if article.is_shared %}
                                <svg class="article-icon shared-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.952a4.5 4.5 0 01-1.897-1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487M16.863 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487z" />
                                </svg>
                                {% else %}
                                <svg class="article-icon personal-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                                </svg>
                                {% endif %}
                                <a href="#" class="article-link" data-id="{{ article.id }}">{{ article.title }}</a>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <p class="no-articles">No articles found.</p>
                {% endfor %}
                </div>
            </nav>
        </aside>

        <!-- Main Viewing Area -->
        <main class="main-area">
            <header class="main-header">
                <div></div>
                <div class="header-actions">
                    <span class="user-info">Logged in as <strong>{{ current_user.name or current_user.username }}</strong></span>
                    {% if current_user.has_permission('is_admin') %}
                    <a href="{{ url_for('backup_restore_page') }}" class="header-btn" title="Backup/Restore">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                        </svg>
                    </a>
                    <a href="{{ url_for('user_management') }}" class="header-btn" title="User Management">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.071M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.663M15 19.128L18 18.5" />
                        </svg>
                    </a>
                    <a href="{{ url_for('settings_page', page='api') }}" class="header-btn" title="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226a2.25 2.25 0 012.58 1.226l.114.683c.137.82.715 1.51 1.505 1.87l.79.395c.837.418 1.258 1.487 1.018 2.45l-.523 1.942a2.25 2.25 0 01-1.342 1.616.25.25 0 00-.056.09l-.443.886c-.42.84-.172 1.86.52 2.445l.698.582c.85.71 1.998.63 2.807-.184l.158-.158a2.25 2.25 0 013.182 0l.53.53a2.25 2.25 0 010 3.182l-.158.158c-.81.81-1.956.89-2.807-.184l-.698-.582c-.692-.585-1.626-.755-2.445-.52l-.886.443a.25.25 0 00-.09.056 2.25 2.25 0 01-1.616 1.342l-1.942.523c-.962.24-1.998-.18-2.45-1.018l-.395-.79a2.25 2.25 0 00-1.87-1.505l-.683-.114a2.25 2.25 0 01-1.226-2.58l.114-.683c.26-1.543-.826-3.023-2.38-3.32l-.79-.158a2.25 2.25 0 01-1.98-2.288v-.04c0-1.26.95-2.322 2.18-2.496l.79-.158c1.554-.3 2.64-1.777 2.38-3.32l-.114-.683z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="header-btn logout-btn" title="Logout">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                        </svg>
                    </a>
                </div>
            </header>
            
            <div id="results-area" class="results-area">
                <div class="welcome-container">
                    <h2 class="welcome-title">Welcome to your Knowledge Base</h2>
                    <p class="welcome-text">Ask a question, or select an article from the left.</p>
                </div>
            </div>
            
            <div class="search-bottom">
                <form id="ask-form" class="ask-form" style="display: flex; gap: 8px; align-items: center;">
                    {% if current_user.has_permission('can_add_kb') %}
                    <button type="button" id="manual-article-btn" style="width: 40px; height: 40px; border-radius: 50%; background: #FBBF24; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: white;" title="Create Manual Article">
                        <svg viewBox="0 0 20 20" fill="currentColor" style="width: 24px; height: 24px;">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    {% endif %}
                    <div class="search-wrapper" style="flex: 1;">
                        <input type="text" id="question-input" class="question-input" placeholder="Ask a question to get started...">
                        <button type="submit" class="search-submit">
                            <svg viewBox="0 0 20 20" fill="currentColor">
                                <path d="M3.105 2.289a.75.75 0 00-.826.95l1.414 4.949a.75.75 0 00.95.544l4.25-1.214a.75.75 0 01.642 1.285l-4.25 1.214a.75.75 0 00-.544.95l-1.414 4.949a.75.75 0 00.95.826L16.25 10l-13.145-7.711z" />
                            </svg>
                        </button>
                    </div>
                </form>
                {% if current_user.has_permission('can_add_kb') %}
                <button id="start-synthesis-btn" class="synthesis-btn hidden">
                    <svg class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Create Article
                </button>
                {% endif %}
            </div>
        </main>
    </div>

    {% include '_modals.html' %}
    {% include '_scripts_index.html' %}
</body>
</html>
