<script>
    const allTags = {{ all_tags|tojson }};
    const allGroups = {{ groups_for_js|tojson|safe }};
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        restoreGroupStates();
    });
    $('#ask-form').addEventListener('submit', handleAskSubmit);
    $('#kb-nav').addEventListener('click', handleSidebarClick);
    $('#select-all-checkbox').addEventListener('change', handleSelectAll);
    $('#bulk-delete-btn').addEventListener('click', () => handleBulkAction('delete'));
    $('#bulk-update-btn').addEventListener('click', () => {
        renderTagButtons('bulk-tags-container', 'bulk-tags');
        populateBulkShareRoles();
        openModal('bulk-update-modal');
    });
    $('#confirm-bulk-update-btn').addEventListener('click', () => handleBulkAction('update'));
    
    // --- Delegated Event Listeners on Body ---
    // This is the section that "tells" the green button what to do.
    // It listens for any click on the page and checks if the click happened on the button.
    document.body.addEventListener('click', function(e) {
        // DEBUG: Log any click on the body to see if events are firing at all
        console.log("Body clicked. Target:", e.target);

        if (e.target.id === 'share-article-btn') {
            handleShareArticle();
        }
        
        // This is the specific check for the green "Create Article" button
        if (e.target.closest('#start-synthesis-btn')) {
            // DEBUG: Confirm the button click is being specifically identified
            console.log("Create Article button was clicked or a child of it was.");
            e.preventDefault();
            openCreateArticleModal();
        }
        
        if (e.target.closest('#add-reference-btn')) {
            addReferenceField();
        }

        if (e.target.closest('.remove-reference-btn')) {
            e.target.closest('.reference-field-group').remove();
        }
    });


    // --- Main Functions ---
    async function handleAskSubmit(e) {
        e.preventDefault();
        const questionInput = $('#question-input');
        if (!questionInput.value.trim()) return;

        $('#results-area').innerHTML = `
            <div class="result-card">
                <h3 class="result-title">Searching Knowledge Sources...</h3>
                <div class="progress-container"><div class="progress-bar"><div id="progress-fill" class="progress-fill" style="width: 10%"></div></div></div>
                <p id="progress-status" class="text-sm text-muted">Initializing...</p>
            </div>`;
        
        const progressFill = $('#progress-fill');
        const progressStatus = $('#progress-status');

        try {
            progressStatus.textContent = 'Querying AI and web services...';
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: questionInput.value }),
            });
            
            progressFill.style.width = '75%';
            progressStatus.textContent = 'Processing results...';

            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            
            const resultsHtml = await response.text();
            
            progressFill.style.width = '100%';
            progressStatus.textContent = 'Done!';

            setTimeout(() => {
                $('#results-area').innerHTML = resultsHtml;
                processRenderedResults();
            }, 500);

        } catch (error) {
            console.error("Search error:", error);
            $('#results-area').innerHTML = `<div class="no-results">Error fetching answers. Please try again.</div>`;
        }
    }

    function processRenderedResults() {
        document.querySelectorAll('.ai-response-card .result-content').forEach(el => {
            el.innerHTML = renderMarkdown(el.textContent);
        });
        const hasResults = document.querySelector('#synthesis-section .result-card');
        const synthesisBtn = $('#start-synthesis-btn');
        if (synthesisBtn) {
            synthesisBtn.classList.toggle('hidden', !hasResults);
        }
    }

    function handleSidebarClick(e) {
        const articleLink = e.target.closest('.article-link');
        const editBtn = e.target.closest('.edit-article-btn');
        const checkbox = e.target.closest('.article-checkbox');
        const groupToggle = e.target.closest('.group-toggle');

        if (articleLink) { e.preventDefault(); handleArticleClick(articleLink.dataset.id); }
        if (editBtn) { e.preventDefault(); openEditModal(editBtn.dataset.id); }
        if (checkbox) { updateBulkActionBar(); }
        if(groupToggle) {
            const groupName = groupToggle.dataset.groupName;
            const articleList = groupToggle.nextElementSibling;
            const chevron = groupToggle.querySelector('.chevron-icon');
            articleList.classList.toggle('collapsed');
            groupToggle.classList.toggle('collapsed');
            updateGroupState(groupName, articleList.classList.contains('collapsed'));
        }
    }

    async function handleArticleClick(id) {
        const response = await fetch(`/get/article/${id}`);
        const article = await response.json();
        $('#modal-title').textContent = article.title;
        let contentHtml = `<h3>Synthesized Content</h3>${renderArticleContent(article.content)}`;
        if (article.notes) contentHtml += `<h3 class="mt-6">Notes</h3>${renderMarkdown(article.notes)}`;
        if (article.references) contentHtml += `<h3 class="mt-6">References</h3><ul>${article.references.split('\n').filter(Boolean).map(l => `<li><a href="${l}" target="_blank">${l}</a></li>`).join('')}</ul>`;
        if (article.tags) contentHtml += `<div class="mt-6"><h3>Tags</h3>${article.tags.split(',').map(t => `<span class="bg-indigo-100 text-xs mr-2 px-2.5 py-0.5 rounded-full">${t.trim()}</span>`).join('')}</div>`;
        $('#modal-content').innerHTML = contentHtml;
        openModal('article-modal');
    }

    // --- NEW "CREATE ARTICLE" MODAL LOGIC ---
    function openCreateArticleModal() {
        // DEBUG: Confirm the function is being entered
        console.log("openCreateArticleModal function started.");

        const selectedCheckboxes = $$('#synthesis-section input[type="checkbox"]:checked');
        
        // DEBUG: Log how many checkboxes were found
        console.log(`Found ${selectedCheckboxes.length} selected checkboxes.`);

        if (selectedCheckboxes.length === 0) {
            console.error('No results were selected. Halting modal opening.');
            // This alert is for user feedback in case the console isn't open.
            alert('Please select one or more search results to create an article.');
            return;
        }

        const selectedContents = Array.from(selectedCheckboxes).map(cb => {
            const card = cb.closest('.result-card');
            const title = card.querySelector('.result-title')?.textContent || 'AI Response';
            const content = cb.dataset.content;
            return { title, content };
        });
        
        let selectedHtml = '<h4 class="text-md font-semibold text-gray-800 mb-2">Selected Content</h4><div class="space-y-2 max-h-40 overflow-y-auto bg-gray-50 p-3 rounded-md border">';
        selectedContents.forEach(item => {
            selectedHtml += `<div class="p-2 border-b"><p class="font-semibold text-sm">${escapeHTML(item.title)}</p><p class="text-xs text-gray-600 truncate">${escapeHTML(item.content)}</p></div>`;
        });
        selectedHtml += '</div>';

        const modalContent = `
            ${selectedHtml}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                <div><label class="block text-sm font-medium">Title</label><input type="text" id="create-title" class="mt-1 w-full rounded-md border-gray-300"></div>
                <div><label class="block text-sm font-medium">Group</label><select id="create-group-id" class="mt-1 w-full rounded-md border-gray-300">${buildGroupOptions()}</select></div>
            </div>
            <div><label class="block text-sm font-medium">Notes (Markdown supported)</label><textarea id="create-notes" rows="4" class="mt-1 w-full rounded-md border-gray-300"></textarea></div>
            <div>
                <label class="block text-sm font-medium">Tags (comma-separated)</label>
                <input type="text" id="create-tags" class="mt-1 w-full rounded-md border-gray-300">
                 <div id="create-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <div>
                <label class="block text-sm font-medium">References</label>
                <div id="references-container" class="space-y-2 mt-1"></div>
                <button type="button" id="add-reference-btn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800">+ Add URL</button>
            </div>
        `;
        
        $('#create-article-modal-content').innerHTML = modalContent;
        $('#create-title').value = $('#question-input').value;
        renderTagButtons('create-tags-container', 'create-tags');

        const references = Array.from(selectedCheckboxes)
            .map(cb => cb.dataset.link)
            .filter(Boolean);
        if (references.length > 0) {
            references.forEach(url => addReferenceField(url));
        } else {
            addReferenceField();
        }

        $('#confirm-create-btn').onclick = handleConfirmCreateArticle;
        openModal('create-article-modal');
    }

    function addReferenceField(url = '', name = '') {
        const container = $('#references-container');
        const newField = document.createElement('div');
        newField.className = 'flex items-center gap-2 reference-field-group';
        newField.innerHTML = `
            <input type="text" placeholder="URL" value="${escapeHTML(url)}" class="flex-1 w-full text-sm rounded-md border-gray-300 reference-url">
            <input type="text" placeholder="Optional Name" value="${escapeHTML(name)}" class="flex-1 w-full text-sm rounded-md border-gray-300 reference-name">
            <button type="button" class="p-1 text-red-500 hover:text-red-700 remove-reference-btn">&times;</button>
        `;
        container.appendChild(newField);
    }

    async function handleConfirmCreateArticle() {
        const selectedContents = Array.from($$('#synthesis-section input[type="checkbox"]:checked')).map(cb => cb.dataset.content);

        const references = Array.from($$('.reference-field-group')).map(group => ({
            url: group.querySelector('.reference-url').value,
            name: group.querySelector('.reference-name').value
        })).filter(ref => ref.url.trim() !== '');

        const payload = {
            title: $('#create-title').value,
            group_id: $('#create-group-id').value,
            notes: $('#create-notes').value,
            tags: $('#create-tags').value,
            texts: selectedContents,
            references: references
        };

        if (!payload.title || !payload.group_id) {
            alert('Title and Group are required.');
            return;
        }

        const btn = $('#confirm-create-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        await fetch('/create_article', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        location.reload();
    }
    
    // --- Other Functions (Unchanged) ---
    async function openEditModal(id) {
        const res = await fetch(`/get/article/${id}`);
        const article = await res.json();
        const content = `
            <input type="hidden" id="edit-id" value="${article.id}">
            <div><label class="block text-sm font-medium">Title</label><input type="text" id="edit-title" value="${escapeHTML(article.title)}" class="mt-1 w-full rounded-md border-gray-300"></div>
            <div><label class="block text-sm font-medium">Group</label><select id="edit-group-id" class="mt-1 w-full rounded-md border-gray-300">${buildGroupOptions(article.group_id)}</select></div>
            <div><label class="block text-sm font-medium">Notes</label><textarea id="edit-notes" rows="4" class="mt-1 w-full rounded-md border-gray-300">${escapeHTML(article.notes)}</textarea></div>
            <div><label class="block text-sm font-medium">References</label><textarea id="edit-references" rows="2" class="mt-1 w-full rounded-md border-gray-300">${escapeHTML(article.references)}</textarea></div>
            <div>
                <label class="block text-sm font-medium">Tags</label>
                <input type="text" id="edit-tags" value="${escapeHTML(article.tags)}" class="mt-1 w-full rounded-md border-gray-300">
                <div id="edit-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        `;
        $('#edit-modal-content').innerHTML = content;
        renderTagButtons('edit-tags-container', 'edit-tags');
        $('#confirm-edit-btn').onclick = handleConfirmEdit;
        $('#open-share-modal-btn').onclick = () => openShareModal(id);
        openModal('edit-modal');
    }
    async function handleConfirmEdit() {
        const id = $('#edit-id').value;
        const payload = {
            title: $('#edit-title').value, group_id: $('#edit-group-id').value,
            notes: $('#edit-notes').value, references: $('#edit-references').value, tags: $('#edit-tags').value
        };
        await fetch(`/edit/article/${id}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }
    async function openShareModal(articleId) {
        const res = await fetch(`/article/sharing_details/${articleId}`);
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        let content = `<input type="hidden" id="share-article-id" value="${articleId}">`;
        data.roles.forEach(role => {
            content += `
                <div><label class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 share-role-checkbox" value="${role.id}" ${role.shared ? 'checked' : ''}>
                        <span class="ml-2 text-sm">${role.name}</span>
                </label></div>`;
        });
        $('#share-modal-content').innerHTML = content;
        $('#confirm-share-btn').onclick = handleConfirmShare;
        openModal('share-modal');
    }
    async function handleConfirmShare() {
        const articleId = $('#share-article-id').value;
        const roleIds = Array.from($$('.share-role-checkbox:checked')).map(cb => cb.value);
        await fetch('/article/share', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_id: articleId, role_ids: roleIds })
        });
        closeModal('share-modal');
        location.reload();
    }
    async function handleBulkAction(action) {
        const ids = Array.from($$('.article-checkbox:checked')).map(cb => cb.dataset.id);
        if (ids.length === 0) return;
        let payload = { action, ids };
        if (action === 'update') {
            payload.data = {
                notes: $('#bulk-notes').value, references: $('#bulk-references').value, tags: $('#bulk-tags').value,
                share_mode: $('#bulk-share-mode').value,
                role_ids: Array.from($$('#bulk-roles-container input:checked')).map(cb => cb.value)
            };
            closeModal('bulk-update-modal');
        } else if (action === 'delete') {
            if (!confirm(`Are you sure you want to delete ${ids.length} articles?`)) return;
        }
        await fetch('/bulk_action', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }
    function handleSelectAll(e) {
        $$('.article-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
        updateBulkActionBar();
    }
    function updateBulkActionBar() {
        const count = $$('.article-checkbox:checked').length;
        $('#selection-count').textContent = count;
        $('#bulk-actions-bar').classList.toggle('hidden', count === 0);
    }
    async function populateBulkShareRoles() {
        const container = $('#bulk-roles-container');
        const res = await fetch('/get/roles');
        const roles = await res.json();
        container.innerHTML = roles.map(role => `<label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600" value="${role.id}"><span class="ml-2 text-sm">${role.name}</span></label>`).join('');
    }
    function buildGroupOptions(selectedId) {
        let html = '';
        const topLevel = allGroups.filter(g => g.parent_id === null);
        function renderOptions(groups, depth = 0) {
            for (const group of groups) {
                const isSelected = group.id === selectedId ? 'selected' : '';
                const prefix = '&nbsp;&nbsp;'.repeat(depth);
                html += `<option value="${group.id}" ${isSelected}>${prefix}${group.name}</option>`;
                const children = allGroups.filter(g => g.parent_id === group.id);
                if (children.length > 0) renderOptions(children, depth + 1);
            }
        }
        renderOptions(topLevel);
        return html;
    }
    function openModal(id) {
        const modal = $(`#${id}`);
        if (!modal) return;
        $('#modal-backdrop').classList.remove('hidden');
        modal.classList.remove('hidden');
        void modal.offsetWidth; 
        modal.classList.add('modal-enter-active');
        modal.classList.remove('modal-enter');
    }
    function closeModal(id) {
        const modal = $(`#${id}`);
        if (!modal) return;
        modal.classList.add('modal-leave-active');
        modal.classList.remove('modal-enter-active');
        setTimeout(() => {
            if (id === 'create-article-modal') {
                $('#create-article-modal-content').innerHTML = '';
                const btn = $('#confirm-create-btn');
                btn.disabled = false;
                btn.textContent = 'Create KB Article';
            }
            $('#modal-backdrop').classList.add('hidden');
            modal.classList.add('hidden');
            modal.classList.remove('modal-leave-active');
            modal.classList.add('modal-enter');
        }, 200);
    }
    function renderTagButtons(containerId, inputId) {
        const container = $(`#${containerId}`);
        container.innerHTML = allTags.map(tag => `<button type="button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-full" data-tag="${escapeHTML(tag)}">${escapeHTML(tag)}</button>`).join('');
        container.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const tag = e.target.dataset.tag;
                const input = $(`#${inputId}`);
                const currentTags = new Set(input.value.split(',').map(t => t.trim()).filter(Boolean));
                currentTags.add(tag);
                input.value = Array.from(currentTags).join(', ');
            }
        });
    }
    function escapeHTML(str) { 
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function renderMarkdown(text) {
        if (window.marked) {
            const html = marked.parse(text || '');
            const container = document.createElement('div');
            container.innerHTML = html;
            container.querySelectorAll('pre code').forEach((block) => { hljs.highlightElement(block); });
            return container.innerHTML;
        }
        return escapeHTML(text || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }
    function renderArticleContent(content) {
        const parts = content.split('\n\n---\n\n');
        let html = '';
        parts.forEach(part => {
            const match = part.match(/^Title: (.*?)\nSnippet: (.*?)\nLink: (.*)$/s);
            if (match) {
                const [, title, snippet, link] = match;
                html += `<div class="border rounded-lg p-4 my-4"><p class="font-semibold text-gray-800 bg-yellow-100 p-2 rounded-md">${escapeHTML(title)}</p><p class="text-sm mt-2 text-gray-600">${escapeHTML(snippet)}</p><div class="mt-2"><a href="${escapeHTML(link)}" target="_blank" class="inline-block text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 font-medium">Source Link</a></div></div>`;
            } else {
                html += renderMarkdown(part);
            }
        });
        return html;
    }
    function restoreGroupStates() {
        const collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups')) || [];
        $$('.group-toggle').forEach(toggle => {
            const groupName = toggle.dataset.groupName;
            if (collapsedGroups.includes(groupName)) {
                toggle.nextElementSibling.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        });
    }
    function updateGroupState(groupName, isCollapsed) {
        let collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups')) || [];
        if (isCollapsed) {
            if (!collapsedGroups.includes(groupName)) collapsedGroups.push(groupName);
        } else {
            collapsedGroups = collapsedGroups.filter(name => name !== groupName);
        }
        localStorage.setItem('collapsedGroups', JSON.stringify(collapsedGroups));
    }
</script>
