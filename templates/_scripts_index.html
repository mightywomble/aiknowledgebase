<script>
    const allTags = {{ all_tags|tojson }};
    const allGroups = {{ groups_for_js|tojson|safe }};
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        restoreGroupStates();
    });
    $('#ask-form').addEventListener('submit', handleAskSubmit);
    $('#kb-nav').addEventListener('click', handleSidebarClick);
    $('#select-all-checkbox').addEventListener('change', handleSelectAll);
    $('#bulk-delete-btn').addEventListener('click', () => handleBulkAction('delete'));
    $('#bulk-update-btn').addEventListener('click', () => {
        renderTagButtons('bulk-tags-container', 'bulk-tags');
        populateBulkShareRoles();
        openModal('bulk-update-modal');
    });
    $('#confirm-bulk-update-btn').addEventListener('click', () => handleBulkAction('update'));
    
    // This button exists inside a modal, so we delegate the event listener
    document.body.addEventListener('click', function(e) {
        if (e.target.id === 'share-article-btn') {
            handleShareArticle();
        }
    });


    // --- Main Functions ---
    async function handleAskSubmit(e) {
        e.preventDefault();
        const questionInput = $('#question-input');
        if (!questionInput.value.trim()) return;

        // Show loading state with Progress Bar
        $('#results-area').innerHTML = `
            <div class="result-card">
                <h3 class="result-title">Searching Knowledge Sources...</h3>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 10%"></div>
                    </div>
                </div>
                <p id="progress-status" class="text-sm text-muted">Initializing...</p>
            </div>`;
        
        const progressFill = $('#progress-fill');
        const progressStatus = $('#progress-status');

        try {
            progressStatus.textContent = 'Querying AI and web services...';
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: questionInput.value }),
            });
            
            progressFill.style.width = '75%';
            progressStatus.textContent = 'Processing results...';

            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            
            const resultsHtml = await response.text();
            
            progressFill.style.width = '100%';
            progressStatus.textContent = 'Done!';

            setTimeout(() => {
                $('#results-area').innerHTML = resultsHtml;
                processRenderedResults();
            }, 500);

        } catch (error) {
            console.error("Search error:", error);
            $('#results-area').innerHTML = `<div class="no-results">Error fetching answers. Please try again.</div>`;
        }
    }

    function processRenderedResults() {
        // Find all AI response cards and render their content as Markdown
        document.querySelectorAll('.ai-response-card .result-content').forEach(el => {
            el.innerHTML = renderMarkdown(el.textContent);
        });

        // Check if there are any results to synthesize
        const hasResults = document.querySelector('#synthesis-section .result-card');

        // Show the "Create Article" button only if there are results
        const synthesisBtn = $('#start-synthesis-btn');
        if (synthesisBtn && hasResults) {
            synthesisBtn.classList.remove('hidden');
            synthesisBtn.addEventListener('click', openSynthesisModal);
        } else if (synthesisBtn) {
            // Ensure the button is hidden if there are no results
            synthesisBtn.classList.add('hidden');
        }
    }

    function handleSidebarClick(e) {
        const articleLink = e.target.closest('.article-link');
        const editBtn = e.target.closest('.edit-article-btn');
        const checkbox = e.target.closest('.article-checkbox');
        const groupToggle = e.target.closest('.group-toggle');

        if (articleLink) {
            e.preventDefault();
            handleArticleClick(articleLink.dataset.id);
        }
        if (editBtn) {
            e.preventDefault();
            openEditModal(editBtn.dataset.id);
        }
        if (checkbox) {
            updateBulkActionBar();
        }
        if(groupToggle) {
            const groupName = groupToggle.dataset.groupName;
            const articleList = groupToggle.nextElementSibling;
            const chevron = groupToggle.querySelector('.chevron-icon');
            
            articleList.classList.toggle('collapsed');
            groupToggle.classList.toggle('collapsed');
            
            updateGroupState(groupName, articleList.classList.contains('collapsed'));
        }
    }

    async function handleArticleClick(id) {
        const response = await fetch(`/get/article/${id}`);
        const article = await response.json();
        $('#modal-title').textContent = article.title;
        
        let contentHtml = `<h3>Synthesized Content</h3>${renderArticleContent(article.content)}`;

        if (article.notes) contentHtml += `<h3 class="mt-6">Notes</h3>${renderMarkdown(article.notes)}`;
        if (article.references) contentHtml += `<h3 class="mt-6">References</h3><ul>${article.references.split('\n').filter(Boolean).map(l => `<li><a href="${l}" target="_blank">${l}</a></li>`).join('')}</ul>`;
        if (article.tags) contentHtml += `<div class="mt-6"><h3>Tags</h3>${article.tags.split(',').map(t => `<span class="bg-indigo-100 text-xs mr-2 px-2.5 py-0.5 rounded-full">${t.trim()}</span>`).join('')}</div>`;
        
        $('#modal-content').innerHTML = contentHtml;
        openModal('article-modal');
    }

    async function handleShareArticle() {
        const title = $('#modal-title').textContent;
        const content = $('#modal-content').innerText;
        if (navigator.share) {
            try {
                await navigator.share({ title: title, text: `Article: ${title}\n\n${content}` });
            } catch (error) { console.error('Share error:', error); }
        } else {
            try {
                await navigator.clipboard.writeText(`Article: ${title}\n\n${content}`);
                alert('Article content copied to clipboard!');
            } catch (err) {
                console.error('Clipboard copy failed:', err);
                alert('Could not copy to clipboard.');
            }
        }
    }
    
    function buildGroupOptions(selectedId) {
        let html = '';
        const topLevel = allGroups.filter(g => g.parent_id === null);
        
        function renderOptions(groups, depth = 0) {
            for (const group of groups) {
                const isSelected = group.id === selectedId ? 'selected' : '';
                const prefix = '&nbsp;&nbsp;'.repeat(depth);
                html += `<option value="${group.id}" ${isSelected}>${prefix}${group.name}</option>`;
                const children = allGroups.filter(g => g.parent_id === group.id);
                if (children.length > 0) {
                    renderOptions(children, depth + 1);
                }
            }
        }
        renderOptions(topLevel);
        return html;
    }

    async function openEditModal(id) {
        const res = await fetch(`/get/article/${id}`);
        const article = await res.json();
        const content = `
            <input type="hidden" id="edit-id" value="${article.id}">
            <div><label class="block text-sm font-medium">Title</label><input type="text" id="edit-title" value="${escapeHTML(article.title)}" class="mt-1 w-full rounded-md border-gray-300"></div>
            <div><label class="block text-sm font-medium">Group</label><select id="edit-group-id" class="mt-1 w-full rounded-md border-gray-300">${buildGroupOptions(article.group_id)}</select></div>
            <div><label class="block text-sm font-medium">Notes</label><textarea id="edit-notes" rows="4" class="mt-1 w-full rounded-md border-gray-300">${escapeHTML(article.notes)}</textarea></div>
            <div><label class="block text-sm font-medium">References</label><textarea id="edit-references" rows="2" class="mt-1 w-full rounded-md border-gray-300">${escapeHTML(article.references)}</textarea></div>
            <div>
                <label class="block text-sm font-medium">Tags</label>
                <input type="text" id="edit-tags" value="${escapeHTML(article.tags)}" class="mt-1 w-full rounded-md border-gray-300">
                <div id="edit-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        `;
        $('#edit-modal-content').innerHTML = content;
        renderTagButtons('edit-tags-container', 'edit-tags');
        $('#confirm-edit-btn').onclick = handleConfirmEdit;
        $('#open-share-modal-btn').onclick = () => openShareModal(id);
        openModal('edit-modal');
    }

    async function handleConfirmEdit() {
        const id = $('#edit-id').value;
        const payload = {
            title: $('#edit-title').value, group_id: $('#edit-group-id').value,
            notes: $('#edit-notes').value, references: $('#edit-references').value, tags: $('#edit-tags').value
        };
        await fetch(`/edit/article/${id}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }

    async function openShareModal(articleId) {
        const res = await fetch(`/article/sharing_details/${articleId}`);
        const data = await res.json();
        if (data.error) {
            alert(data.error);
            return;
        }

        let content = `<input type="hidden" id="share-article-id" value="${articleId}">`;
        data.roles.forEach(role => {
            content += `
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 share-role-checkbox" value="${role.id}" ${role.shared ? 'checked' : ''}>
                        <span class="ml-2 text-sm">${role.name}</span>
                    </label>
                </div>`;
        });

        $('#share-modal-content').innerHTML = content;
        $('#confirm-share-btn').onclick = handleConfirmShare;
        openModal('share-modal');
    }

    async function handleConfirmShare() {
        const articleId = $('#share-article-id').value;
        const roleIds = Array.from($$('.share-role-checkbox:checked')).map(cb => cb.value);
        
        await fetch('/article/share', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_id: articleId, role_ids: roleIds })
        });
        closeModal('share-modal');
        location.reload();
    }

    function openSynthesisModal() {
        const selectedCheckboxes = $$('#synthesis-section input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) return alert('Please select results to create an article.');
        const content = `
            <div class="flex items-end gap-2">
                <div class="flex-grow">
                    <label class="block text-sm font-medium">Group</label>
                    <select id="new-group-id" class="mt-1 w-full rounded-md border-gray-300">${buildGroupOptions()}</select>
                </div>
                <button id="add-group-toggle-btn" class="flex-shrink-0 p-2 bg-gray-200 rounded-md hover:bg-gray-300">+</button>
            </div>
            <div id="add-group-form" class="hidden p-3 mt-2 border rounded-md bg-gray-50 space-y-2">
                <label class="block text-sm font-medium">New Group Name</label>
                <input type="text" id="new-group-name" placeholder="New group name..." class="w-full text-sm rounded-md border-gray-300">
                <label class="block text-sm font-medium">Parent Group (Optional)</label>
                <select id="new-group-parent-id" class="w-full text-sm rounded-md border-gray-300"><option value="">None (Top-level)</option>${buildGroupOptions()}</select>
                <button id="add-group-confirm-btn" class="text-sm bg-green-500 text-white px-3 py-1 rounded-md">Add</button>
            </div>
            <div><label class="block text-sm font-medium">Title</label><input type="text" id="new-title" class="mt-1 w-full rounded-md border-gray-300"></div>
            <div><label class="block text-sm font-medium">Notes</label><textarea id="new-notes" rows="4" class="mt-1 w-full rounded-md border-gray-300"></textarea></div>
            <div><label class="block text-sm font-medium">References</label><textarea id="new-references" rows="2" class="mt-1 w-full rounded-md border-gray-300"></textarea></div>
            <div>
                <label class="block text-sm font-medium">Tags</label>
                <input type="text" id="new-tags" class="mt-1 w-full rounded-md border-gray-300">
                <div id="new-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
        `;
        $('#synthesis-modal-content').innerHTML = content;
        
        $('#new-title').value = $('#question-input').value;

        const references = Array.from(selectedCheckboxes)
            .map(cb => cb.closest('.result-card').querySelector('.result-link')?.href)
            .filter(Boolean);
        if (references.length > 0) {
            $('#new-references').value = references.join('\n');
        }

        renderTagButtons('new-tags-container', 'new-tags');
        $('#confirm-synthesis-btn').onclick = handleConfirmSynthesis;
        $('#add-group-toggle-btn').onclick = () => $('#add-group-form').classList.toggle('hidden');
        $('#add-group-confirm-btn').onclick = handleAddGroupInModal;
        openModal('synthesis-modal');
    }
    
    async function handleAddGroupInModal() {
        const name = $('#new-group-name').value;
        const parentId = $('#new-group-parent-id').value;
        if (!name) return;
        
        const formData = new FormData();
        formData.append('name', name);
        formData.append('parent_id', parentId);

        await fetch('/group/add', { method: 'POST', body: formData });
        
        alert('Group added! The page will now reload to update the group list.');
        location.reload();
    }

    async function handleConfirmSynthesis() {
        const textsToSynthesize = Array.from($$('#synthesis-section input[type="checkbox"]:checked')).map(checkbox => checkbox.dataset.content);
        
        const payload = {
            title: $('#new-title').value, group_id: $('#new-group-id').value,
            notes: $('#new-notes').value, references: $('#new-references').value, tags: $('#new-tags').value,
            texts: textsToSynthesize
        };
        if (!payload.title || !payload.group_id) return alert('Title and Group are required.');
        
        const btn = $('#confirm-synthesis-btn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        await fetch('/synthesize', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }
    
    async function handleBulkAction(action) {
        const ids = Array.from($$('.article-checkbox:checked')).map(cb => cb.dataset.id);
        if (ids.length === 0) return;
        
        let payload = { action, ids };
        if (action === 'update') {
            payload.data = {
                notes: $('#bulk-notes').value,
                references: $('#bulk-references').value,
                tags: $('#bulk-tags').value,
                share_mode: $('#bulk-share-mode').value,
                role_ids: Array.from($$('#bulk-roles-container input:checked')).map(cb => cb.value)
            };
            closeModal('bulk-update-modal');
        } else if (action === 'delete') {
            if (!confirm(`Are you sure you want to delete ${ids.length} articles?`)) return;
        }

        await fetch('/bulk_action', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }
    
    function handleSelectAll(e) {
        $$('.article-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
        updateBulkActionBar();
    }

    function updateBulkActionBar() {
        const count = $$('.article-checkbox:checked').length;
        $('#selection-count').textContent = count;
        $('#bulk-actions-bar').classList.toggle('hidden', count === 0);
    }
    
    async function populateBulkShareRoles() {
        const container = $('#bulk-roles-container');
        const res = await fetch('/get/roles');
        const roles = await res.json();
        container.innerHTML = roles.map(role => `
            <label class="flex items-center">
                <input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600" value="${role.id}">
                <span class="ml-2 text-sm">${role.name}</span>
            </label>
        `).join('');
    }

    // --- UI & Modal ---
    function openModal(id) {
        const modal = $(`#${id}`);
        if (!modal) return;
        
        $('#modal-backdrop').classList.remove('hidden');
        modal.classList.remove('hidden');
        
        void modal.offsetWidth; 

        modal.classList.add('modal-enter-active');
        modal.classList.remove('modal-enter');
    }

    function closeModal(id) {
        const modal = $(`#${id}`);
        if (!modal) return;

        modal.classList.add('modal-leave-active');
        modal.classList.remove('modal-enter-active');

        setTimeout(() => {
            if (id === 'synthesis-modal') {
                ['new-title', 'new-group-id', 'new-notes', 'new-references', 'new-tags'].forEach(inputId => {
                    const el = $(`#${inputId}`);
                    if (el) el.value = '';
                });
                const btn = $('#confirm-synthesis-btn');
                btn.disabled = false;
                btn.textContent = 'Create Article';
            }

            $('#modal-backdrop').classList.add('hidden');
            modal.classList.add('hidden');
            modal.classList.remove('modal-leave-active');
            modal.classList.add('modal-enter');
        }, 200);
    }
    
    function renderTagButtons(containerId, inputId) {
        const container = $(`#${containerId}`);
        container.innerHTML = allTags.map(tag => `<button type="button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-full" data-tag="${escapeHTML(tag)}">${escapeHTML(tag)}</button>`).join('');
        container.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const tag = e.target.dataset.tag;
                const input = $(`#${inputId}`);
                const currentTags = new Set(input.value.split(',').map(t => t.trim()).filter(Boolean));
                currentTags.add(tag);
                input.value = Array.from(currentTags).join(', ');
            }
        });
    }
    
    function escapeHTML(str) { 
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function renderMarkdown(text) {
        if (window.marked) {
            const html = marked.parse(text || '');
            const container = document.createElement('div');
            container.innerHTML = html;
            container.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
            return container.innerHTML;
        }
        let html = escapeHTML(text || '');
        return html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }
    function renderArticleContent(content) {
        const parts = content.split('\n\n---\n\n');
        let html = '';
        parts.forEach(part => {
            const match = part.match(/^Title: (.*?)\nSnippet: (.*?)\nLink: (.*)$/s);
            if (match) {
                const [, title, snippet, link] = match;
                html += `<div class="border rounded-lg p-4 my-4"><p class="font-semibold text-gray-800 bg-yellow-100 p-2 rounded-md">${escapeHTML(title)}</p><p class="text-sm mt-2 text-gray-600">${escapeHTML(snippet)}</p><div class="mt-2"><a href="${escapeHTML(link)}" target="_blank" class="inline-block text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 font-medium">Source Link</a></div></div>`;
            } else {
                html += renderMarkdown(part);
            }
        });
        return html;
    }
    function restoreGroupStates() {
        const collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups')) || [];
        $$('.group-toggle').forEach(toggle => {
            const groupName = toggle.dataset.groupName;
            if (collapsedGroups.includes(groupName)) {
                toggle.nextElementSibling.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        });
    }
    function updateGroupState(groupName, isCollapsed) {
        let collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups')) || [];
        if (isCollapsed) {
            if (!collapsedGroups.includes(groupName)) {
                collapsedGroups.push(groupName);
            }
        } else {
            collapsedGroups = collapsedGroups.filter(name => name !== groupName);
        }
        localStorage.setItem('collapsedGroups', JSON.stringify(collapsedGroups));
    }
</script>
