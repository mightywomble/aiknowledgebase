<script>
    const allTags = {{ all_tags|tojson }};
    const allGroups = {{ groups_for_js|tojson|safe }};
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        restoreGroupStates();
    });
    $('#ask-form').addEventListener('submit', handleAskSubmit);
    $('#kb-nav').addEventListener('click', handleSidebarClick);
    $('#select-all-checkbox').addEventListener('change', handleSelectAll);
    $('#bulk-delete-btn').addEventListener('click', () => handleBulkAction('delete'));
    $('#bulk-update-btn').addEventListener('click', () => {
        renderTagButtons('bulk-tags-container', 'bulk-tags');
        populateBulkShareRoles();
        openModal('bulk-update-modal');
    });
    $('#confirm-bulk-update-btn').addEventListener('click', () => handleBulkAction('update'));
    
    // --- Delegated Event Listeners on Body ---
    document.body.addEventListener('click', function(e) {
        if (e.target.id === 'share-article-btn' || e.target.closest('#share-article-btn')) {
            const articleId = $('#modal-title').textContent;
            const article = document.querySelector('[data-article-id]');
            // Get article ID from modal context - fetch it from the currently displayed article
            const modalTitle = $('#modal-title');
            const articleLink = document.querySelector(`.article-link[data-id]`);
            // Actually, we need to store the article ID when viewing. Let me use a better approach:
            const shareBtn = e.target.closest('#share-article-btn');
            if (shareBtn) {
                // Get the article ID from stored state when article modal was opened
                if (window.currentArticleId) {
                    openShareModal(window.currentArticleId);
                }
            }
        }
        
        if (e.target.closest('#start-synthesis-btn')) {
            e.preventDefault();
            openCreateArticleModal();
        }
        
        if (e.target.closest('#add-reference-btn')) {
            addReferenceField();
        }

        if (e.target.closest('.remove-reference-btn')) {
            e.target.closest('.reference-field-group').remove();
        }
    });


    // --- Main Functions ---
    async function handleAskSubmit(e) {
        e.preventDefault();
        const questionInput = $('#question-input');
        if (!questionInput.value.trim()) return;

        $('#results-area').innerHTML = `
            <div class="result-card">
                <h3 class="result-title">Searching Knowledge Sources...</h3>
                <div class="progress-container"><div class="progress-bar"><div id="progress-fill" class="progress-fill" style="width: 10%"></div></div></div>
                <p id="progress-status" class="text-sm text-muted">Initializing...</p>
            </div>`;
        
        const progressFill = $('#progress-fill');
        const progressStatus = $('#progress-status');

        try {
            progressStatus.textContent = 'Querying AI and web services...';
            const response = await fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: questionInput.value }),
            });
            
            progressFill.style.width = '75%';
            progressStatus.textContent = 'Processing results...';

            if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
            
            const resultsHtml = await response.text();
            
            progressFill.style.width = '100%';
            progressStatus.textContent = 'Done!';

            setTimeout(() => {
                $('#results-area').innerHTML = resultsHtml;
                processRenderedResults();
            }, 500);

        } catch (error) {
            console.error("Search error:", error);
            $('#results-area').innerHTML = `<div class="no-results">Error fetching answers. Please try again.</div>`;
        }
    }

    function processRenderedResults() {
        document.querySelectorAll('.ai-response-card .result-content').forEach(el => {
            el.innerHTML = renderMarkdown(el.textContent);
        });
        const hasResults = document.querySelector('#synthesis-section .result-card');
        const synthesisBtn = $('#start-synthesis-btn');
        if (synthesisBtn) {
            synthesisBtn.classList.toggle('hidden', !hasResults);
        }
    }

    function handleSidebarClick(e) {
        const articleLink = e.target.closest('.article-link');
        const editBtn = e.target.closest('.edit-article-btn');
        const checkbox = e.target.closest('.article-checkbox');
        const groupToggle = e.target.closest('.group-toggle');

        if (articleLink) { e.preventDefault(); handleArticleClick(articleLink.dataset.id); }
        if (editBtn) { e.preventDefault(); openEditModal(editBtn.dataset.id); }
        if (checkbox) { updateBulkActionBar(); }
        if(groupToggle) {
            const groupName = groupToggle.dataset.groupName;
            const articleList = groupToggle.nextElementSibling;
            const chevron = groupToggle.querySelector('.chevron-icon');
            articleList.classList.toggle('collapsed');
            groupToggle.classList.toggle('collapsed');
            updateGroupState(groupName, articleList.classList.contains('collapsed'));
        }
    }

    // MODIFIED: This function now correctly builds the "View Article" modal with the desired glass plane design.
    async function handleArticleClick(id) {
        window.currentArticleId = id; // Store article ID for sharing
        const response = await fetch(`/get/article/${id}`);
        const article = await response.json();
        article.is_private = article.is_private || false; // Ensure is_private exists
        $('#modal-title').textContent = article.title;

        let contentHtml = `<div class="space-y-4">`; // Main container for all sections

        // Synthesized Content Plane
        contentHtml += `
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                <h4 class="text-md font-semibold text-white mb-3">Synthesized Content</h4>
                <div class="prose prose-invert prose-sm max-w-none">${renderArticleContent(article.content)}</div>
            </div>`;

        // Notes Plane
        if (article.notes) {
            contentHtml += `
                <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                    <h4 class="text-md font-semibold text-white mb-3">Notes</h4>
                    <div class="prose prose-invert prose-sm max-w-none">${renderMarkdown(article.notes)}</div>
                </div>`;
        }

        // References Plane
        if (article.references) {
            const referenceLines = article.references.split('\n').filter(Boolean);
            const referenceListItems = referenceLines.map(line => {
                // Extracts URL from markdown link like "- [text](url)" or handles plain URL
                const match = line.match(/\[.*?\]\((.*?)\)/); 
                const url = match ? match[1] : (line.trim().startsWith('- ') ? line.trim().substring(2) : line.trim());
                return `<li><a href="${escapeHTML(url)}" target="_blank" class="text-indigo-400 hover:underline">${escapeHTML(url)}</a></li>`;
            }).join('');

             contentHtml += `
                <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                    <h4 class="text-md font-semibold text-white mb-3">References</h4>
                    <div class="prose prose-invert prose-sm max-w-none"><ul>${referenceListItems}</ul></div>
                </div>`;
        }
        
        // Tags Plane
        if (article.tags) {
            contentHtml += `
                <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                    <h4 class="text-md font-semibold text-white mb-3">Tags</h4>
                    <div class="flex flex-wrap gap-2">${article.tags.split(',').map(t => `<span class="bg-indigo-500/20 text-indigo-300 text-xs mr-2 px-2.5 py-0.5 rounded-full">${t.trim()}</span>`).join('')}</div>
                </div>`;
        }
        
        contentHtml += `</div>`; // Close main container
        
        $('#modal-content').innerHTML = contentHtml;
        openModal('article-modal');
    }

    // --- "CREATE ARTICLE" MODAL LOGIC ---
    function openCreateArticleModal() {
        const selectedCheckboxes = $$('#synthesis-section input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Please select one or more search results to create an article.');
            return;
        }

        const selectedContents = Array.from(selectedCheckboxes).map(cb => {
            const card = cb.closest('.result-card');
            const title = card.querySelector('.result-title')?.textContent || 'AI Response';
            const content = cb.dataset.content;
            return { title, content };
        });
        
        let selectedHtml = `
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                <h4 class="text-md font-semibold text-white mb-2">Selected Content</h4>
                <div class="space-y-2 max-h-40 overflow-y-auto p-1 rounded-md">
                    ${selectedContents.map(item => `
                        <div class="p-2 border-b border-[var(--glass-border)]">
                            <p class="font-semibold text-sm text-gray-200">${escapeHTML(item.title)}</p>
                            <p class="text-xs text-gray-400 truncate">${escapeHTML(item.content)}</p>
                        </div>
                    `).join('')}
                </div>
            </div>`;

        const modalContent = `
            ${selectedHtml}
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                <h4 class="text-md font-semibold text-white mb-3">Article Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-300">Title</label><input type="text" id="create-title" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                    <div><label class="block text-sm font-medium text-gray-300">Group</label><select id="create-group-id" class="mt-1 w-full rounded-md bg-[#16213e] border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">${buildGroupOptions()}</select></div>
                </div>
                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="create-is-private" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="create-is-private" class="ml-2 block text-sm text-gray-300">Make this article private (only you can see it)</label>
                </div>
            </div>
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                 <h4 class="text-md font-semibold text-white mb-3">Notes & Tags</h4>
                 <div><label class="block text-sm font-medium text-gray-300">Notes (Markdown supported)</label><textarea id="create-notes" rows="4" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea></div>
                 <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-300">Tags (comma-separated)</label>
                    <input type="text" id="create-tags" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <div id="create-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)]">
                <h4 class="text-md font-semibold text-white mb-3">References</h4>
                <div id="references-container" class="space-y-2 mt-1"></div>
                <button type="button" id="add-reference-btn" class="mt-2 text-sm text-indigo-400 hover:text-indigo-300">+ Add URL</button>
            </div>
        `;
        
        $('#create-article-modal-content').innerHTML = modalContent;
        $('#create-title').value = $('#question-input').value;
        renderTagButtons('create-tags-container', 'create-tags');

        const references = Array.from(selectedCheckboxes)
            .map(cb => cb.dataset.link)
            .filter(Boolean);
        if (references.length > 0) {
            references.forEach(url => addReferenceField(url));
        } else {
            addReferenceField();
        }

        $('#confirm-create-btn').onclick = handleConfirmCreateArticle;
        openModal('create-article-modal');
    }

    function addReferenceField(url = '', name = '') {
        const container = $('#references-container');
        const newField = document.createElement('div');
        newField.className = 'flex items-center gap-2 reference-field-group';
        newField.innerHTML = `
            <input type="text" placeholder="URL" value="${escapeHTML(url)}" class="flex-1 w-full text-sm rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 reference-url">
            <input type="text" placeholder="Optional Name" value="${escapeHTML(name)}" class="flex-1 w-full text-sm rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 reference-name">
            <button type="button" class="p-1 text-red-500 hover:text-red-400 remove-reference-btn text-2xl font-bold">&times;</button>
        `;
        container.appendChild(newField);
    }

    async function handleConfirmCreateArticle() {
        const selectedContents = Array.from($$('#synthesis-section input[type="checkbox"]:checked')).map(cb => cb.dataset.content);
        const references = Array.from($$('.reference-field-group')).map(group => ({
            url: group.querySelector('.reference-url').value,
            name: group.querySelector('.reference-name').value
        })).filter(ref => ref.url.trim() !== '');

        const payload = {
            title: $('#create-title').value, group_id: $('#create-group-id').value,
            notes: $('#create-notes').value, tags: $('#create-tags').value,
            texts: selectedContents, references: references,
            is_private: $('#create-is-private').checked
        };

        if (!payload.title || !payload.group_id) {
            alert('Title and Group are required.');
            return;
        }

        const btn = $('#confirm-create-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        await fetch('/create_article', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        location.reload();
    }
    
    // --- Other Functions ---
    async function openEditModal(id) {
        const res = await fetch(`/get/article/${id}`);
        const article = await res.json();
        const content = `
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)] space-y-4">
                 <div><label class="block text-sm font-medium text-gray-300">Title</label><input type="text" id="edit-title" value="${escapeHTML(article.title)}" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></div>
                <div><label class="block text-sm font-medium text-gray-300">Group</label><select id="edit-group-id" class="mt-1 w-full rounded-md bg-[#16213e] border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">${buildGroupOptions(article.group_id)}</select></div>
            </div>
            <div class="p-4 bg-black/20 rounded-lg border border-[var(--glass-border)] space-y-4">
                <div><label class="block text-sm font-medium text-gray-300">Notes</label><textarea id="edit-notes" rows="4" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">${escapeHTML(article.notes)}</textarea></div>
                <div><label class="block text-sm font-medium text-gray-300">References</label><textarea id="edit-references" rows="2" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">${escapeHTML(article.references)}</textarea></div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Tags</label>
                    <input type="text" id="edit-tags" value="${escapeHTML(article.tags)}" class="mt-1 w-full rounded-md bg-transparent border-[var(--glass-border)] text-white placeholder-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <div id="edit-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="edit-is-private" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${article.is_private ? 'checked' : ''}>
                    <label for="edit-is-private" class="ml-2 block text-sm text-gray-300">Make this article private (only you can see it)</label>
                </div>
            </div>
        `;
        $('#edit-modal-content').innerHTML = content;
        renderTagButtons('edit-tags-container', 'edit-tags');
        $('#confirm-edit-btn').onclick = handleConfirmEdit;
        $('#open-share-modal-btn').onclick = () => openShareModal(id);
        openModal('edit-modal');
    }
    async function handleConfirmEdit() {
        const id = $('#edit-id').value;
        const payload = {
            title: $('#edit-title').value, group_id: $('#edit-group-id').value,
            notes: $('#edit-notes').value, references: $('#edit-references').value, tags: $('#edit-tags').value,
            is_private: $('#edit-is-private').checked
        };
        await fetch(`/edit/article/${id}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }
    async function openShareModal(articleId) {
        const res = await fetch(`/article/sharing_details/${articleId}`);
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        let content = `<input type="hidden" id="share-article-id" value="${articleId}">`;
        content += `
            <div class="space-y-4">
                <div class="flex items-start">
                    <input type="radio" id="share-public" name="visibility" class="h-4 w-4 text-indigo-600" value="public" ${!data.is_private ? 'checked' : ''}>
                    <div class="ml-3">
                        <label for="share-public" class="block text-sm font-medium text-gray-300">Public (shared with all users)</label>
                        <p class="text-xs text-gray-400 mt-1">Everyone on this system can view this article</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <input type="radio" id="share-private" name="visibility" class="h-4 w-4 text-indigo-600" value="private" ${data.is_private ? 'checked' : ''}>
                    <div class="ml-3">
                        <label for="share-private" class="block text-sm font-medium text-gray-300">Private (only you)</label>
                        <p class="text-xs text-gray-400 mt-1">Only you can view this article</p>
                    </div>
                </div>
            </div>
        `;
        $('#share-modal-content').innerHTML = content;
        $('#confirm-share-btn').onclick = handleConfirmShare;
        openModal('share-modal');
    }
    async function handleConfirmShare() {
        const articleId = $('#share-article-id').value;
        const visibility = document.querySelector('input[name="visibility"]:checked').value;
        const is_private = visibility === 'private';
        await fetch('/article/share', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ article_id: articleId, is_private: is_private })
        });
        closeModal('share-modal');
        location.reload();
    }
    async function handleBulkAction(action) {
        const ids = Array.from($$('.article-checkbox:checked')).map(cb => cb.dataset.id);
        if (ids.length === 0) return;
        let payload = { action, ids };
        if (action === 'update') {
            payload.data = {
                notes: $('#bulk-notes').value, references: $('#bulk-references').value, tags: $('#bulk-tags').value,
                share_mode: $('#bulk-share-mode').value,
                role_ids: Array.from($$('#bulk-roles-container input:checked')).map(cb => cb.value)
            };
            closeModal('bulk-update-modal');
        } else if (action === 'delete') {
            if (!confirm(`Are you sure you want to delete ${ids.length} articles?`)) return;
        }
        await fetch('/bulk_action', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        location.reload();
    }
    function handleSelectAll(e) {
        $$('.article-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
        updateBulkActionBar();
    }
    function updateBulkActionBar() {
        const count = $$('.article-checkbox:checked').length;
        $('#selection-count').textContent = count;
        $('#bulk-actions-bar').classList.toggle('hidden', count === 0);
    }
    async function populateBulkShareRoles() {
        const container = $('#bulk-roles-container');
        const res = await fetch('/get/roles');
        const roles = await res.json();
        container.innerHTML = roles.map(role => `<label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600" value="${role.id}"><span class="ml-2 text-sm">${role.name}</span></label>`).join('');
    }
    function buildGroupOptions(selectedId) {
        let html = '';
        const topLevel = allGroups.filter(g => g.parent_id === null);
        function renderOptions(groups, depth = 0) {
            for (const group of groups) {
                const isSelected = group.id === selectedId ? 'selected' : '';
                const prefix = '&nbsp;&nbsp;'.repeat(depth);
                html += `<option value="${group.id}" ${isSelected}>${prefix}${group.name}</option>`;
                const children = allGroups.filter(g => g.parent_id === group.id);
                if (children.length > 0) renderOptions(children, depth + 1);
            }
        }
        renderOptions(topLevel);
        return html;
    }
    function openModal(id) {
        const modal = $(`#${id}`);
        if (!modal) return;
        $('#modal-backdrop').classList.remove('hidden');
        modal.classList.remove('hidden');
        void modal.offsetWidth; 
        modal.classList.add('modal-enter-active');
        modal.classList.remove('modal-enter');
    }
    function closeModal(id) {
        const modal = $(`#${id}`);
        if (!modal) return;
        modal.classList.add('modal-leave-active');
        modal.classList.remove('modal-enter-active');
        setTimeout(() => {
            if (id === 'create-article-modal') {
                $('#create-article-modal-content').innerHTML = '';
                const btn = $('#confirm-create-btn');
                btn.disabled = false;
                btn.textContent = 'Create KB Article';
            }
            $('#modal-backdrop').classList.add('hidden');
            modal.classList.add('hidden');
            modal.classList.remove('modal-leave-active');
            modal.classList.add('modal-enter');
        }, 200);
    }
    function renderTagButtons(containerId, inputId) {
        const container = $(`#${containerId}`);
        container.innerHTML = allTags.map(tag => `<button type="button" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-full" data-tag="${escapeHTML(tag)}">${escapeHTML(tag)}</button>`).join('');
        container.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const tag = e.target.dataset.tag;
                const input = $(`#${inputId}`);
                const currentTags = new Set(input.value.split(',').map(t => t.trim()).filter(Boolean));
                currentTags.add(tag);
                input.value = Array.from(currentTags).join(', ');
            }
        });
    }
    function escapeHTML(str) { 
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function renderMarkdown(text) {
        if (window.marked) {
            const html = marked.parse(text || '', { breaks: true }); // Enable line breaks
            const container = document.createElement('div');
            container.innerHTML = html;
            container.querySelectorAll('pre code').forEach((block) => { hljs.highlightElement(block); });
            return container.innerHTML;
        }
        return escapeHTML(text || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }

    // MODIFIED: This function now correctly un-escapes newlines and renders the source snippets in the desired "glass box" style.
    function renderArticleContent(content) {
        const parts = content.split('\n\n---\n\n');
        let html = '';
        parts.forEach(part => {
            // Un-escape literal "\\n" sequences into actual newlines for robust parsing
            const unescapedPart = part.replace(/\\n/g, '\n');
            const match = unescapedPart.match(/^Title: (.*?)\nSnippet: (.*?)\nLink: (.*)$/s);
            
            if (match) {
                const [, title, snippet, link] = match;
                html += `
                    <div class="bg-black/20 border border-[var(--glass-border)] rounded-lg p-4 my-4">
                        <p class="font-semibold text-indigo-300">${escapeHTML(title)}</p>
                        <p class="text-sm mt-2 text-gray-300">${escapeHTML(snippet)}</p>
                        <div class="mt-3">
                            <a href="${escapeHTML(link)}" target="_blank" class="inline-block text-xs bg-blue-500/20 text-blue-300 px-3 py-1 rounded-full hover:bg-blue-500/40 font-medium">
                                View Source
                            </a>
                        </div>
                    </div>`;
            } else {
                html += renderMarkdown(part);
            }
        });
        return html;
    }

    function restoreGroupStates() {
        const collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups')) || [];
        $$('.group-toggle').forEach(toggle => {
            const groupName = toggle.dataset.groupName;
            if (collapsedGroups.includes(groupName)) {
                toggle.nextElementSibling.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        });
    }
    function updateGroupState(groupName, isCollapsed) {
        let collapsedGroups = JSON.parse(localStorage.getItem('collapsedGroups')) || [];
        if (isCollapsed) {
            if (!collapsedGroups.includes(groupName)) collapsedGroups.push(groupName);
        } else {
            collapsedGroups = collapsedGroups.filter(name => name !== groupName);
        }
        localStorage.setItem('collapsedGroups', JSON.stringify(collapsedGroups));
    }
</script>
